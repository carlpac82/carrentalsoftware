<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Automation Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Outfit', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-6">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Price Automation Settings</h1>
                <p class="text-gray-600 mt-1">Configure all parameters for price automation. Changes are applied in real-time.</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="exportSettings()" class="p-2 text-[#009cb6] hover:bg-[#009cb6] hover:text-white border border-[#009cb6] rounded transition-all" title="Export All Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                </button>
                <button onclick="importSettings()" class="p-2 text-[#f4ad0f] hover:bg-[#f4ad0f] hover:text-white border border-[#f4ad0f] rounded transition-all" title="Import All Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                </button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)">
            </div>
        </div>

        <!-- Regras Globais -->
        <div class="bg-white shadow mb-6 p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                </svg>
                Global Settings
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Broker Commission (%)</label>
                    <input type="number" id="comissaoBroker" value="13.66" step="0.01" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                    <p class="text-xs text-gray-500 mt-1">NET Price = Final Price / (1 + commission)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Margin (%)</label>
                    <input type="number" id="defaultMargin" value="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                    <p class="text-xs text-gray-500 mt-1">Default: 0% (no margin when no rule exists)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rounding</label>
                    <select id="rounding" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                        <option value="0.01" selected>Cents (0.01â‚¬)</option>
                        <option value="0.50">Half Euro (0.50â‚¬)</option>
                        <option value="1.00">Euro (1.00â‚¬)</option>
                        <option value="5.00">5 Euros (5.00â‚¬)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alternative Search (days ahead)</label>
                    <input type="number" id="maxAlternativeDays" value="3" min="0" max="7" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                    <p class="text-xs text-gray-500 mt-1">If no prices found, try up to X days ahead (0-7, same month only)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Exclude Suppliers from Calculations</label>
                    <div class="border border-gray-300 rounded p-3 max-h-48 overflow-y-auto bg-white">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="excludeSuppliersCheckboxes">
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="autoprudente" checked class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">AutoPrudente</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="hertz" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Hertz</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="avis" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Avis</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="budget" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Budget</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="europcar" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Europcar</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="sixt" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Sixt</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="enterprise" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Enterprise</span>
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                <input type="checkbox" value="goldcar" class="mr-2 exclude-supplier-checkbox">
                                <span class="text-sm">Goldcar</span>
                            </label>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Selected suppliers will be excluded from price calculations</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Location</label>
                    <select id="defaultLocation" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                        <option value="Albufeira">Albufeira</option>
                        <option value="Aeroporto de Faro">Faro Airport</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Auto-save to History</label>
                    <select id="autoSaveHistory" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                        <option value="true" selected>Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Automatically save prices to history on download</p>
                </div>
            </div>

            <div class="border-t pt-4 mb-4">
                <h3 class="text-md font-semibold mb-3 text-gray-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-[#f4ad0f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Group Hierarchy & Price Validation
                </h3>
                <p class="text-sm text-gray-600 mb-3">Define group price dependencies to ensure pricing consistency across vehicle categories.</p>
                
                <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                    <p class="text-sm text-blue-800"><strong>Rule:</strong> Define price comparison rules between groups.</p>
                    <p class="text-xs text-blue-600 mt-1"><strong>Operators:</strong> â‰¥ (greater or equal), â‰¤ (less or equal), > (greater than)</p>
                    <p class="text-xs text-blue-600 mt-1">Example: D â‰¥ B1 AND D â‰¥ B2 means group D price must be â‰¥ both B1 and B2</p>
                </div>

                <div class="mb-3">
                    <label class="flex items-center gap-2 mb-2">
                        <input type="checkbox" id="enableGroupHierarchy" class="w-4 h-4 text-[#009cb6] border-gray-300 rounded focus:ring-[#009cb6]">
                        <span class="text-sm font-medium text-gray-700">Enable Group Hierarchy Validation</span>
                    </label>
                </div>

                <div id="groupHierarchyConfig" class="hidden">
                    <div class="mb-3 flex items-center justify-between">
                        <label class="block text-sm font-medium text-gray-700">Available Groups</label>
                        <button onclick="showGroupHierarchyBuilder()" class="px-3 py-1.5 text-xs bg-[#009cb6] text-white rounded hover:bg-[#f4ad0f] transition-colors">
                            Configure Dependencies
                        </button>
                    </div>
                    
                    <!-- Groups List -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 p-3 bg-gray-50 rounded border border-gray-200">
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">B1</span> - Mini 4 Doors</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">B2</span> - Mini</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">D</span> - Economy</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">E1</span> - Mini Auto</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">E2</span> - Economy Auto</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">F</span> - SUV</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">G</span> - Premium</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">J1</span> - Crossover</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">J2</span> - Station Wagon</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">L1</span> - SUV Auto</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">L2</span> - SW Auto</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">M1</span> - 7 Seater</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">M2</span> - 7 Seater Auto</div>
                        <div class="text-xs"><span class="font-semibold text-[#009cb6]">N</span> - 9 Seater</div>
                    </div>
                    
                    <!-- Configured Rules Display -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Configured Dependency Rules</label>
                        <div id="hierarchyRulesList" class="space-y-1 min-h-[60px] p-3 bg-white border border-gray-300 rounded">
                            <p class="text-xs text-gray-400 italic" id="noRulesMessage">No rules configured yet. Click "Configure Dependencies" to add rules.</p>
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2">
                        ðŸ’¡ <strong>Tip:</strong> You can define multiple dependencies per group. For example, D can be set to be â‰¥ both B1 and B2.
                    </p>
                </div>
            </div>

            <div class="border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Reference Supplier for Price Calculations
                    <span class="text-xs text-gray-500 font-normal ml-2">(used when reading Current Prices)</span>
                </label>
                <select id="referenceSupplier" class="w-full px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6] focus:border-transparent rounded">
                    <option value="AUTOPRUDENTE" selected>AUTOPRUDENTE (Default)</option>
                    <option value="Hertz">Hertz</option>
                    <option value="Avis">Avis</option>
                    <option value="Europcar">Europcar</option>
                    <option value="Sixt">Sixt</option>
                    <option value="Budget">Budget</option>
                    <option value="Enterprise">Enterprise</option>
                    <option value="Thrifty">Thrifty</option>
                    <option value="Goldcar">Goldcar</option>
                    <option value="Firefly">Firefly</option>
                    <option value="InterRent">InterRent</option>
                    <option value="Keddy">Keddy</option>
                    <option value="Alamo">Alamo</option>
                    <option value="National">National</option>
                    <option value="Dollar">Dollar</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                    This supplier's prices will be used as base for automated price calculations. 
                    Change this if you want to follow a different supplier's pricing strategy.
                </p>
            </div>
        </div>

        <!-- Margens por Categoria - ESCONDIDO -->
        <div class="bg-white shadow mb-6 p-6" style="display: none;">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                Margins by Category
            </h2>
            
            <div class="space-y-3">
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">B1 - Mini 4 Doors</span>
                    <input type="number" value="18" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">B2 - Mini</span>
                    <input type="number" value="17" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">D - Economy</span>
                    <input type="number" value="15" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">E1 - Mini Automatic</span>
                    <input type="number" value="20" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">E2 - Economy Automatic</span>
                    <input type="number" value="18" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">F - SUV</span>
                    <input type="number" value="12" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">G - Premium</span>
                    <input type="number" value="10" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">J1 - Crossover</span>
                    <input type="number" value="14" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">L1 - SUV Automatic</span>
                    <input type="number" value="11" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">M1 - 7 Seater</span>
                    <input type="number" value="13" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">M2 - 7 Seater Automatic</span>
                    <input type="number" value="12" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">N - 9 Seater</span>
                    <input type="number" value="10" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">%</span>
                </div>
            </div>
        </div>

        <!-- Ajustes por PerÃ­odo - ESCONDIDO -->
        <div class="bg-white shadow mb-6 p-6" style="display: none;">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Ajustes por PerÃ­odo (Dias)
            </h2>
            
            <div class="space-y-3">
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">1-3 dias (curta duraÃ§Ã£o)</span>
                    <input type="number" value="5" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">% adicional</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">4-7 dias</span>
                    <input type="number" value="0" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">% adicional</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">8-14 dias</span>
                    <input type="number" value="-2" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">% desconto</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">15-28 dias</span>
                    <input type="number" value="-3" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">% desconto</span>
                </div>
                <div class="grid grid-cols-3 gap-4 items-center">
                    <span class="text-sm font-medium text-gray-700">29+ dias (longa duraÃ§Ã£o)</span>
                    <input type="number" value="-5" step="0.1" class="px-3 py-2 border border-gray-300 focus:ring-2 focus:ring-[#009cb6]">
                    <span class="text-sm text-gray-500">% desconto</span>
                </div>
            </div>
        </div>

        <!-- Automated Price Rules by Location and Group -->
        <div class="bg-white shadow mb-6 p-6">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-[#f4ad0f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Automated Price Rules
            </h2>
            
            <!-- Manual vs AI Settings Tabs -->
            <div class="mb-6 border-b-2 border-gray-200">
                <nav class="flex gap-6">
                    <button onclick="switchMode('manual')" id="tabManual" class="px-4 py-3 border-b-2 border-[#009cb6] text-[#009cb6] font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                        </svg>
                        Manual Settings
                    </button>
                    <button onclick="switchMode('ai')" id="tabAI" class="px-4 py-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        AI Settings
                        <span class="bg-[#f4ad0f] text-white text-xs px-2 py-0.5 rounded-full">BETA</span>
                    </button>
                </nav>
            </div>

            <!-- MANUAL SETTINGS -->
            <div id="manualSettings">
                <p class="text-sm text-gray-600 mb-4">Configure how automated prices are calculated for each location and group</p>
                
                <!-- Location Tabs -->
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex gap-4">
                        <button onclick="switchLocation('albufeira')" id="tabAlbufeira" class="px-4 py-2 border-b-2 border-[#f4ad0f] text-[#f4ad0f] font-semibold">
                            Albufeira
                        </button>
                        <button onclick="switchLocation('faro')" id="tabFaro" class="px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                            Faro Airport
                        </button>
                    </nav>
                </div>

                <!-- Albufeira Rules -->
                <div id="rulesAlbufeira" class="space-y-4">
                    <div class="text-sm font-medium text-gray-700 mb-3">Configure rules for each group:</div>
                    <div id="groupRulesAlbufeira"></div>
                </div>

                <!-- Faro Rules -->
                <div id="rulesFaro" class="hidden space-y-4">
                    <div class="text-sm font-medium text-gray-700 mb-3">Configure rules for each group:</div>
                    <div id="groupRulesFaro"></div>
                </div>
            </div>

            <!-- AI SETTINGS -->
            <div id="aiSettings" class="hidden">
                <div class="bg-gradient-to-r from-[#f4ad0f]/10 to-[#009cb6]/10 p-4 rounded-lg mb-6">
                    <div class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-[#f4ad0f] flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-1">AI Learning System</h3>
                            <p class="text-sm text-gray-600">The AI observes your manual price adjustments in the visual interface and learns patterns to suggest automated rules.</p>
                        </div>
                    </div>
                </div>

                <!-- AI Learning Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Manual Adjustments</div>
                        <div class="text-2xl font-bold text-[#009cb6]" id="aiStatsAdjustments">0</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Patterns Detected</div>
                        <div class="text-2xl font-bold text-[#f4ad0f]" id="aiStatsPatterns">0</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Suggestions Ready</div>
                        <div class="text-2xl font-bold text-green-600" id="aiStatsSuggestions">0</div>
                    </div>
                </div>

                <!-- AI Suggestions -->
                <div id="aiSuggestionsContainer">
                    <!-- Dynamic content -->
                </div>

                <!-- Recent Adjustments Log -->
                <div class="mt-6">
                    <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Recent Manual Adjustments
                    </h3>
                    <div id="aiAdjustmentsLog" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-sm text-gray-500 text-center py-8">No manual adjustments recorded yet. Start adjusting prices in the visual interface to train the AI!</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-6 flex gap-3">
                    <button onclick="clearAIData()" class="px-4 py-2 border border-red-300 text-red-600 hover:bg-red-50 rounded transition-colors">
                        Clear AI Data
                    </button>
                    <button onclick="refreshAISuggestions()" class="px-4 py-2 bg-[#f4ad0f] text-white hover:bg-[#009cb6] rounded transition-colors">
                        Refresh Suggestions
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center">
            <p class="text-sm text-gray-500">ðŸ’¡ Changes are saved automatically</p>
            <div class="flex gap-4">
                <button onclick="resetDefaults()" class="px-6 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors rounded">
                    Reset to Defaults
                </button>
                <button onclick="saveSettings()" class="px-6 py-2 bg-[#009cb6] text-white hover:bg-[#f4ad0f] transition-colors rounded">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <script>
        const grupos = ['B1', 'B2', 'D', 'E1', 'E2', 'F', 'G', 'J1', 'J2', 'L1', 'L2', 'M1', 'M2', 'N'];
        const grupoNames = {
            'B1': 'Mini 4 Doors', 'B2': 'Mini', 'D': 'Economy',
            'E1': 'Mini Automatic', 'E2': 'Economy Automatic',
            'F': 'SUV', 'G': 'Premium', 'J1': 'Crossover', 'J2': 'Station Wagon',
            'L1': 'SUV Automatic', 'L2': 'Station Wagon Automatic',
            'M1': '7 Seater', 'M2': '7 Seater Automatic', 'N': '9 Seater'
        };
        
        // Dias disponÃ­veis (padrÃ£o)
        const availableDays = [1, 2, 3, 4, 5, 6, 7, 8, 9, 14, 22, 28, 31, 60];
        
        // Lista de suppliers principais
        const suppliers = [
            'Hertz', 'Avis', 'Europcar', 'Budget', 'Sixt', 'Enterprise',
            'Thrifty', 'Dollar', 'Alamo', 'National', 'Firefly', 'Goldcar',
            'Centauro', 'OK Mobility', 'Record Go', 'Surprice', 'Interrent',
            'Green Motion', 'Keddy', 'Rhodium', 'Flizzr', 'Ace', 'Addcar',
            'Autoclick', 'Autovia', 'Drivalia', 'Guerin', 'Locauto', 'Maggiore',
            'Sicily', 'Target', 'Wheego', 'Ynot'
        ].sort();
        
        // Carregar configuraÃ§Ãµes ao iniciar
        window.addEventListener('DOMContentLoaded', async function() {
            // Clean old localStorage format if needed
            cleanOldLocalStorageFormat();
            
            await loadSettings();
            await loadStrategies();
            initializeAutomatedRules();
        });
        
        // Clean old format localStorage data
        function cleanOldLocalStorageFormat() {
            const saved = localStorage.getItem('automatedPriceRules');
            if (!saved) return;
            
            try {
                const rules = JSON.parse(saved);
                let needsCleaning = false;
                
                // Check if data is in old format (without months structure)
                for (const location in rules) {
                    for (const grupo in rules[location]) {
                        const grupoData = rules[location][grupo];
                        // Old format: has direct properties without 'months'
                        if (grupoData && !grupoData.months && (grupoData.strategy || grupoData.diffType)) {
                            console.warn(`âš ï¸ Found old format data for ${location}/${grupo}`);
                            needsCleaning = true;
                        }
                    }
                }
                
                if (needsCleaning) {
                    console.warn('ðŸ§¹ Cleaning old localStorage format...');
                    const cleanRules = {};
                    for (const location in rules) {
                        cleanRules[location] = {};
                        for (const grupo in rules[location]) {
                            cleanRules[location][grupo] = { months: {} };
                        }
                    }
                    localStorage.setItem('automatedPriceRules', JSON.stringify(cleanRules));
                    console.log('âœ… Old data cleaned. Please reconfigure your rules.');
                }
            } catch (e) {
                console.error('Error cleaning old format:', e);
            }
        }

        // Group Hierarchy Rules Storage
        // NEW FORMAT: { "D": [{ group: "B1", operator: ">=" }, { group: "B2", operator: ">=" }], ... }
        let groupHierarchyRules = {};

        async function loadSettings() {
            try {
                // Try to load from database first
                const response = await fetch('/api/price-automation/settings/load');
                const result = await response.json();
                
                if (result.ok && result.settings) {
                    const settings = result.settings;
                    if (settings.comissaoBroker) document.getElementById('comissaoBroker').value = settings.comissaoBroker;
                    if (settings.defaultMargin !== undefined) document.getElementById('defaultMargin').value = settings.defaultMargin;
                    if (settings.rounding) document.getElementById('rounding').value = settings.rounding;
                    if (settings.maxAlternativeDays !== undefined) document.getElementById('maxAlternativeDays').value = settings.maxAlternativeDays;
                    
                    // Load excluded suppliers checkboxes
                    if (settings.excludeSuppliers && Array.isArray(settings.excludeSuppliers)) {
                        document.querySelectorAll('.exclude-supplier-checkbox').forEach(cb => {
                            cb.checked = settings.excludeSuppliers.includes(cb.value.toLowerCase());
                        });
                    }
                    
                    if (settings.defaultLocation) document.getElementById('defaultLocation').value = settings.defaultLocation;
                    if (settings.autoSaveHistory !== undefined) document.getElementById('autoSaveHistory').value = settings.autoSaveHistory ? 'true' : 'false';
                    if (settings.referenceSupplier) document.getElementById('referenceSupplier').value = settings.referenceSupplier;
                    if (settings.enableGroupHierarchy !== undefined) {
                        document.getElementById('enableGroupHierarchy').checked = settings.enableGroupHierarchy;
                        toggleGroupHierarchy();
                    }
                    if (settings.groupHierarchyRules && typeof settings.groupHierarchyRules === 'object') {
                        groupHierarchyRules = settings.groupHierarchyRules;
                        renderHierarchyRules();
                    }
                    
                    // Also save to localStorage as backup
                    localStorage.setItem('priceAutomationSettings', JSON.stringify(settings));
                    console.log('âœ… Settings loaded from database');
                    return;
                }
            } catch (err) {
                console.error('Error loading settings from database:', err);
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('priceAutomationSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (settings.comissaoBroker) document.getElementById('comissaoBroker').value = settings.comissaoBroker;
                    if (settings.defaultMargin) document.getElementById('defaultMargin').value = settings.defaultMargin;
                    if (settings.rounding) document.getElementById('rounding').value = settings.rounding;
                    if (settings.maxAlternativeDays !== undefined) document.getElementById('maxAlternativeDays').value = settings.maxAlternativeDays;
                    if (settings.referenceSupplier) document.getElementById('referenceSupplier').value = settings.referenceSupplier;
                    if (settings.groupHierarchyRules && typeof settings.groupHierarchyRules === 'object') {
                        groupHierarchyRules = settings.groupHierarchyRules;
                        renderHierarchyRules();
                    }
                    console.log('âš ï¸ Settings loaded from localStorage (fallback)');
                } catch (e) {
                    console.error('Erro ao carregar configuraÃ§Ãµes:', e);
                }
            }
        }

        async function saveSettings() {
            // Collect excluded suppliers from checkboxes
            const excludedSuppliers = [];
            document.querySelectorAll('.exclude-supplier-checkbox:checked').forEach(cb => {
                excludedSuppliers.push(cb.value.toLowerCase());
            });
            
            // Collect all values
            const settings = {
                comissaoBroker: parseFloat(document.getElementById('comissaoBroker').value),
                defaultMargin: parseFloat(document.getElementById('defaultMargin').value),
                rounding: parseFloat(document.getElementById('rounding').value),
                maxAlternativeDays: parseInt(document.getElementById('maxAlternativeDays').value),
                excludeSuppliers: excludedSuppliers,  // Array of suppliers
                defaultLocation: document.getElementById('defaultLocation').value,
                autoSaveHistory: document.getElementById('autoSaveHistory').value === 'true',
                referenceSupplier: document.getElementById('referenceSupplier').value,
                enableGroupHierarchy: document.getElementById('enableGroupHierarchy').checked,
                groupHierarchyRules: groupHierarchyRules
            };

            // Validate
            if (settings.maxAlternativeDays < 0 || settings.maxAlternativeDays > 7) {
                alert('âš ï¸ Alternative search days must be between 0 and 7');
                return;
            }

            try {
                // Save to database via API
                console.log('ðŸ’¾ Saving settings to database...', settings);
                const response = await fetch('/api/price-automation/settings/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Server returned error:', response.status, errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('ðŸ“¥ Server response:', result);
                
                if (result.ok) {
                    // Also save locally as backup
                    localStorage.setItem('priceAutomationSettings', JSON.stringify(settings));
                    
                    // Save automated rules
                    await saveAutomatedRules();
                    
                    // Save strategies
                    await saveStrategies();

                    // Trigger event for real-time update
                    window.dispatchEvent(new CustomEvent('settingsChanged', { detail: { settings } }));

                    showNotification('âœ… Settings saved to database!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save settings');
                }
            } catch (err) {
                console.error('âŒ Error saving settings:', err);
                // Fallback to localStorage
                localStorage.setItem('priceAutomationSettings', JSON.stringify(settings));
                showNotification(`âš ï¸ Saved locally only. Database error: ${err.message}`, 'warning');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded shadow-lg z-50 max-w-md`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), type === 'warning' ? 5000 : 3000);
        }

        // Auto-save on change
        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    saveSettings();
                });
            });
        }

        function resetDefaults() {
            if (confirm('Reset all settings to default values?')) {
                localStorage.removeItem('priceAutomationSettings');
                document.getElementById('comissaoBroker').value = 13.66;
                document.getElementById('defaultMargin').value = 15;
                document.getElementById('rounding').value = 1.00;
                document.getElementById('maxAlternativeDays').value = 3;
                document.getElementById('defaultLocation').value = 'Albufeira';
                document.getElementById('autoSaveHistory').value = 'true';
                document.getElementById('enableGroupHierarchy').checked = false;
                groupHierarchyRules = {};
                renderHierarchyRules();
                toggleGroupHierarchy();
                saveSettings();
                showNotification('âœ… Settings reset to defaults!');
            }
        }

        // Toggle Group Hierarchy Config Visibility
        function toggleGroupHierarchy() {
            const enabled = document.getElementById('enableGroupHierarchy').checked;
            const config = document.getElementById('groupHierarchyConfig');
            if (enabled) {
                config.classList.remove('hidden');
            } else {
                config.classList.add('hidden');
            }
        }

        // Render Hierarchy Rules List
        function renderHierarchyRules() {
            const container = document.getElementById('hierarchyRulesList');
            const noRulesMsg = document.getElementById('noRulesMessage');
            
            if (!container) return;
            
            // Clear existing rules (except "no rules" message)
            const existingRules = container.querySelectorAll('.hierarchy-rule-item');
            existingRules.forEach(el => el.remove());
            
            if (Object.keys(groupHierarchyRules).length === 0) {
                if (noRulesMsg) noRulesMsg.style.display = 'block';
                return;
            }
            
            if (noRulesMsg) noRulesMsg.style.display = 'none';
            
            // Helper to get operator symbol
            const getOperatorSymbol = (op) => {
                if (op === '>=') return 'â‰¥';
                if (op === '<=') return 'â‰¤';
                if (op === '>') return '>';
                return op;
            };
            
            // Render rules
            for (const [group, dependencies] of Object.entries(groupHierarchyRules)) {
                if (dependencies.length === 0) continue;
                
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'hierarchy-rule-item flex items-center justify-between p-2 bg-blue-50 border border-blue-200 rounded text-xs';
                
                // Build rule text
                let ruleText = '';
                dependencies.forEach((dep, idx) => {
                    const depGroup = typeof dep === 'string' ? dep : dep.group;
                    const operator = typeof dep === 'string' ? 'â‰¥' : getOperatorSymbol(dep.operator);
                    ruleText += `${operator} ${depGroup}`;
                    if (idx < dependencies.length - 1) ruleText += ', ';
                });
                
                ruleDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-[#009cb6]">${group}</span>
                        <span class="text-gray-700">${ruleText}</span>
                    </div>
                    <button onclick="removeHierarchyRule('${group}')" class="text-red-500 hover:text-red-700" title="Remove rule">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                `;
                
                container.appendChild(ruleDiv);
            }
        }
        
        // Show Group Hierarchy Builder Modal
        function showGroupHierarchyBuilder() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full mx-4 max-h-[85vh] overflow-y-auto';
            
            modal.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Configure Group Dependencies</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <p class="text-sm text-gray-600 mb-4">
                    Select a group and define price comparison rules with other groups.
                </p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Group</label>
                    <select id="hierarchyTargetGroup" class="w-full px-3 py-2 border border-gray-300 rounded">
                        <option value="">-- Select a group --</option>
                        ${grupos.map(g => `<option value="${g}">${g} - ${grupoNames[g]}</option>`).join('')}
                    </select>
                </div>
                
                <div id="hierarchyDependenciesSection" class="hidden">
                    <div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs">
                        <strong>ðŸ’¡ How to use:</strong> Select groups and choose an operator for each. You can add multiple rules.
                        <br><strong>â‰¥</strong> means "greater or equal", <strong>â‰¤</strong> means "less or equal", <strong>></strong> means "greater than"
                    </div>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Select groups and operators:
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 p-3 bg-gray-50 rounded border border-gray-200 max-h-[400px] overflow-y-auto">
                        ${grupos.map(g => `
                            <div class="dep-item-container flex items-center gap-2 p-2 bg-white rounded border border-gray-200">
                                <input type="checkbox" value="${g}" class="hierarchy-dep-checkbox w-4 h-4 text-[#009cb6] border-gray-300 rounded flex-shrink-0">
                                <span class="text-sm flex-1">${g} - ${grupoNames[g]}</span>
                                <select class="hierarchy-op-select text-xs px-2 py-1 border border-gray-300 rounded" disabled>
                                    <option value=">=">â‰¥ (greater or equal)</option>
                                    <option value="<=">â‰¤ (less or equal)</option>
                                    <option value=">"> (greater than)</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="applyHierarchyRule()" class="px-4 py-2 bg-[#009cb6] text-white rounded hover:bg-[#f4ad0f]">
                        Apply Rules
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Add event listener for group selection
            const targetGroupSelect = modal.querySelector('#hierarchyTargetGroup');
            const dependenciesSection = modal.querySelector('#hierarchyDependenciesSection');
            
            targetGroupSelect.addEventListener('change', function() {
                if (this.value) {
                    dependenciesSection.classList.remove('hidden');
                    
                    // Load existing rules for this group
                    const existingDeps = groupHierarchyRules[this.value] || [];
                    const containers = modal.querySelectorAll('.dep-item-container');
                    
                    containers.forEach(container => {
                        const checkbox = container.querySelector('.hierarchy-dep-checkbox');
                        const operatorSelect = container.querySelector('.hierarchy-op-select');
                        
                        // Disable self-selection
                        if (checkbox.value === this.value) {
                            checkbox.disabled = true;
                            checkbox.checked = false;
                            operatorSelect.disabled = true;
                            container.classList.add('opacity-50');
                        } else {
                            checkbox.disabled = false;
                            container.classList.remove('opacity-50');
                            
                            // Check if this group exists in rules
                            const existingRule = existingDeps.find(dep => {
                                return typeof dep === 'string' ? dep === checkbox.value : dep.group === checkbox.value;
                            });
                            
                            if (existingRule) {
                                checkbox.checked = true;
                                operatorSelect.disabled = false;
                                operatorSelect.value = typeof existingRule === 'string' ? '>=' : existingRule.operator;
                            } else {
                                checkbox.checked = false;
                                operatorSelect.disabled = true;
                                operatorSelect.value = '>=';
                            }
                        }
                    });
                } else {
                    dependenciesSection.classList.add('hidden');
                }
            });
            
            // Enable/disable operator select based on checkbox
            modal.addEventListener('change', function(e) {
                if (e.target.classList.contains('hierarchy-dep-checkbox')) {
                    const container = e.target.closest('.dep-item-container');
                    const operatorSelect = container.querySelector('.hierarchy-op-select');
                    operatorSelect.disabled = !e.target.checked;
                }
            });
        }
        
        // Apply Hierarchy Rule
        function applyHierarchyRule() {
            const modal = document.querySelector('.fixed.inset-0');
            const targetGroup = modal.querySelector('#hierarchyTargetGroup').value;
            
            if (!targetGroup) {
                alert('Please select a group');
                return;
            }
            
            const selectedDeps = [];
            const containers = modal.querySelectorAll('.dep-item-container');
            
            containers.forEach(container => {
                const checkbox = container.querySelector('.hierarchy-dep-checkbox');
                const operatorSelect = container.querySelector('.hierarchy-op-select');
                
                if (checkbox.checked && !checkbox.disabled) {
                    selectedDeps.push({
                        group: checkbox.value,
                        operator: operatorSelect.value
                    });
                }
            });
            
            // Update rules
            if (selectedDeps.length === 0) {
                delete groupHierarchyRules[targetGroup];
            } else {
                groupHierarchyRules[targetGroup] = selectedDeps;
            }
            
            // Render updated rules
            renderHierarchyRules();
            
            // Save settings
            saveSettings();
            
            // Close modal
            modal.remove();
            
            showNotification(`âœ… ${selectedDeps.length} rule(s) applied for group ${targetGroup}`);
        }
        
        // Remove Hierarchy Rule
        function removeHierarchyRule(group) {
            if (confirm(`Remove all dependency rules for group ${group}?`)) {
                delete groupHierarchyRules[group];
                renderHierarchyRules();
                saveSettings();
                showNotification(`âœ… Rule removed for group ${group}`);
            }
        }
        
        // Validate Group Hierarchy Prices
        function validateGroupHierarchy(prices) {
            const settings = JSON.parse(localStorage.getItem('priceAutomationSettings') || '{}');
            if (!settings.enableGroupHierarchy || !groupHierarchyRules || Object.keys(groupHierarchyRules).length === 0) {
                return { valid: true, errors: [] };
            }

            const errors = [];

            // Check each group's dependencies
            for (const [group, dependencies] of Object.entries(groupHierarchyRules)) {
                // Check all day periods
                for (const day in prices[group] || {}) {
                    const groupPrice = parseFloat(prices[group]?.[day]);
                    
                    if (isNaN(groupPrice)) continue;
                    
                    // Check against all dependencies
                    for (const dep of dependencies) {
                        const depGroup = typeof dep === 'string' ? dep : dep.group;
                        const operator = typeof dep === 'string' ? '>=' : dep.operator;
                        const depPrice = parseFloat(prices[depGroup]?.[day]);
                        
                        if (isNaN(depPrice)) continue;
                        
                        let isValid = true;
                        let errorMsg = '';
                        
                        switch(operator) {
                            case '>=':
                                isValid = groupPrice >= depPrice;
                                errorMsg = `${group} (${groupPrice.toFixed(2)}â‚¬) must be â‰¥ ${depGroup} (${depPrice.toFixed(2)}â‚¬) for ${day} days`;
                                break;
                            case '<=':
                                isValid = groupPrice <= depPrice;
                                errorMsg = `${group} (${groupPrice.toFixed(2)}â‚¬) must be â‰¤ ${depGroup} (${depPrice.toFixed(2)}â‚¬) for ${day} days`;
                                break;
                            case '>':
                                isValid = groupPrice > depPrice;
                                errorMsg = `${group} (${groupPrice.toFixed(2)}â‚¬) must be > ${depGroup} (${depPrice.toFixed(2)}â‚¬) for ${day} days`;
                                break;
                        }
                        
                        if (!isValid) {
                            errors.push({
                                day: day,
                                group: group,
                                dependencyGroup: depGroup,
                                operator: operator,
                                groupPrice: groupPrice.toFixed(2),
                                depPrice: depPrice.toFixed(2),
                                message: errorMsg
                            });
                        }
                    }
                }
            }

            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        // Initialize
        loadSettings();
        setupAutoSave();
        
        // Add event listener for hierarchy toggle
        document.getElementById('enableGroupHierarchy').addEventListener('change', function() {
            toggleGroupHierarchy();
            saveSettings();
        });
        
        // ===== AUTOMATED PRICE RULES =====
        
        // ===== MANUAL vs AI SETTINGS =====
        
        function switchMode(mode) {
            const tabManual = document.getElementById('tabManual');
            const tabAI = document.getElementById('tabAI');
            const manualSettings = document.getElementById('manualSettings');
            const aiSettings = document.getElementById('aiSettings');
            
            if (mode === 'manual') {
                tabManual.className = 'px-4 py-3 border-b-2 border-[#009cb6] text-[#009cb6] font-semibold flex items-center gap-2';
                tabAI.className = 'px-4 py-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 flex items-center gap-2';
                manualSettings.classList.remove('hidden');
                aiSettings.classList.add('hidden');
            } else {
                tabAI.className = 'px-4 py-3 border-b-2 border-[#f4ad0f] text-[#f4ad0f] font-semibold flex items-center gap-2';
                tabManual.className = 'px-4 py-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 flex items-center gap-2';
                aiSettings.classList.remove('hidden');
                manualSettings.classList.add('hidden');
                // Load AI data when switching to AI tab
                loadAISettings();
            }
        }
        
        function loadAISettings() {
            const aiData = JSON.parse(localStorage.getItem('priceAIData') || '{"adjustments": [], "patterns": {}, "suggestions": []}');
            
            // Update stats
            document.getElementById('aiStatsAdjustments').textContent = aiData.adjustments.length;
            document.getElementById('aiStatsPatterns').textContent = Object.keys(aiData.patterns).length;
            document.getElementById('aiStatsSuggestions').textContent = aiData.suggestions.length;
            
            // Render adjustments log
            renderAdjustmentsLog(aiData.adjustments);
            
            // Render suggestions
            renderAISuggestions(aiData.suggestions);
        }
        
        function renderAdjustmentsLog(adjustments) {
            const container = document.getElementById('aiAdjustmentsLog');
            
            if (adjustments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 px-4">
                        <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <p class="text-gray-700 font-medium mb-3">No manual adjustments yet</p>
                        <div class="text-sm text-gray-600 space-y-2 max-w-md mx-auto text-left bg-blue-50 border border-blue-200 rounded p-4">
                            <p class="font-medium text-blue-900">ðŸ“ How to train the AI:</p>
                            <ol class="list-decimal list-inside space-y-1 ml-2">
                                <li>Go to <strong>Price Automation</strong> page</li>
                                <li>Click <strong>Generate</strong> to load competitor prices</li>
                                <li>In <strong>Visual mode</strong>, drag the <span class="text-yellow-600 font-bold">slider</span> to adjust prices</li>
                                <li>Each slider adjustment is recorded as AI learning</li>
                                <li>After 5-10 adjustments, come back here to see suggestions!</li>
                            </ol>
                        </div>
                        <button onclick="generateSampleAIData()" class="mt-4 px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors text-sm font-medium">
                            Generate Sample Data (for testing)
                        </button>
                    </div>
                `;
                return;
            }
            
            // Show last 20 adjustments
            const recent = adjustments.slice(-20).reverse();
            
            container.innerHTML = recent.map(adj => {
                const date = new Date(adj.timestamp);
                const timeStr = date.toLocaleString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                const priceDiff = adj.newPrice - adj.originalPrice;
                const diffPercent = ((priceDiff / adj.originalPrice) * 100).toFixed(1);
                const diffColor = priceDiff > 0 ? 'text-red-600' : 'text-green-600';
                const diffIcon = priceDiff > 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                
                return `
                    <div class="bg-gray-50 p-3 rounded border border-gray-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-gray-900">${adj.group} - ${adj.days} day${adj.days > 1 ? 's' : ''}</div>
                                <div class="text-xs text-gray-600 mt-1">${adj.location}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm">${adj.newPrice.toFixed(2)}â‚¬</div>
                                <div class="text-xs ${diffColor}">${diffIcon} ${priceDiff > 0 ? '+' : ''}${diffPercent}%</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">${timeStr}</div>
                        ${adj.competitorContext ? `
                            <div class="text-xs text-gray-600 mt-1">
                                vs AutoPrudente: ${adj.competitorContext.autoPrudente?.toFixed(2)}â‚¬,
                                Lowest: ${adj.competitorContext.lowest?.toFixed(2)}â‚¬
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function renderAISuggestions(suggestions) {
            const container = document.getElementById('aiSuggestionsContainer');
            
            if (suggestions.length === 0) {
                container.innerHTML = `
                    <div class="bg-gray-50 p-8 rounded-lg text-center">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        <p class="text-gray-600">No suggestions yet. The AI needs more data to detect patterns.</p>
                        <p class="text-sm text-gray-500 mt-2">Make at least 5-10 manual adjustments to start seeing suggestions.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-[#f4ad0f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    AI-Generated Suggestions
                </h3>
                <div class="space-y-3">
                    ${suggestions.map((sug, idx) => `
                        <div class="bg-gradient-to-r from-[#f4ad0f]/5 to-[#009cb6]/5 p-4 rounded-lg border border-[#f4ad0f]/30">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <div class="font-semibold text-gray-900">${sug.group} - ${sug.location}</div>
                                    <div class="text-sm text-gray-600 mt-1">${sug.description}</div>
                                </div>
                                <span class="bg-[#f4ad0f] text-white text-xs px-2 py-1 rounded">Confidence: ${sug.confidence}%</span>
                            </div>
                            <div class="bg-white p-3 rounded mt-3 text-sm">
                                <div class="font-medium text-gray-700 mb-2">Suggested Rule:</div>
                                <div class="text-gray-900">${sug.ruleText}</div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="applyAISuggestion(${idx})" class="px-3 py-1 bg-[#009cb6] text-white rounded hover:bg-[#f4ad0f] transition-colors text-sm">
                                    Apply Rule
                                </button>
                                <button onclick="dismissSuggestion(${idx})" class="px-3 py-1 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors text-sm">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function refreshAISuggestions() {
            console.log('ðŸ¤– Refreshing AI suggestions...');
            const aiData = JSON.parse(localStorage.getItem('priceAIData') || '{"adjustments": [], "patterns": {}, "suggestions": []}');
            
            // Analyze patterns and generate suggestions
            aiData.suggestions = analyzeAndSuggest(aiData.adjustments);
            
            // Save
            localStorage.setItem('priceAIData', JSON.stringify(aiData));
            
            // Reload
            loadAISettings();
        }
        
        function analyzeAndSuggest(adjustments) {
            if (adjustments.length < 5) return [];
            
            const suggestions = [];
            const groupedByGroup = {};
            
            // Group adjustments by group
            adjustments.forEach(adj => {
                const key = `${adj.location}-${adj.group}`;
                if (!groupedByGroup[key]) groupedByGroup[key] = [];
                groupedByGroup[key].push(adj);
            });
            
            // Analyze each group
            Object.entries(groupedByGroup).forEach(([key, adjs]) => {
                if (adjs.length < 3) return;
                
                const [location, group] = key.split('-');
                
                // Calculate average position relative to competitors
                let totalDiff = 0;
                let validComparisons = 0;
                
                adjs.forEach(adj => {
                    if (adj.competitorContext && adj.competitorContext.lowest) {
                        const diff = adj.newPrice - adj.competitorContext.lowest;
                        totalDiff += diff;
                        validComparisons++;
                    }
                });
                
                if (validComparisons >= 3) {
                    const avgDiff = totalDiff / validComparisons;
                    const confidence = Math.min(95, 50 + (validComparisons * 5));
                    
                    suggestions.push({
                        group: group,
                        location: location,
                        description: `Based on ${validComparisons} manual adjustments, you typically price ${avgDiff.toFixed(2)}â‚¬ ${avgDiff > 0 ? 'above' : 'below'} the lowest competitor.`,
                        ruleText: `Follow Lowest Price ${avgDiff > 0 ? '+' : ''}${avgDiff.toFixed(2)}â‚¬`,
                        confidence: Math.round(confidence),
                        data: { avgDiff, validComparisons }
                    });
                }
            });
            
            return suggestions;
        }
        
        function clearAIData() {
            if (confirm('âš ï¸ Are you sure you want to clear all AI learning data? This cannot be undone.')) {
                localStorage.removeItem('priceAIData');
                loadAISettings();
                alert('âœ… AI data cleared successfully!');
            }
        }
        
        function applyAISuggestion(index) {
            const aiData = JSON.parse(localStorage.getItem('priceAIData') || '{"adjustments": [], "patterns": {}, "suggestions": []}');
            const suggestion = aiData.suggestions[index];
            
            if (!suggestion) return;
            
            alert(`ðŸ¤– AI Suggestion Applied!\n\nThis would apply the rule to ${suggestion.group} in ${suggestion.location}.\n\n(Full implementation coming soon)`);
            
            // TODO: Actually apply the rule to manual settings
        }
        
        function dismissSuggestion(index) {
            const aiData = JSON.parse(localStorage.getItem('priceAIData') || '{"adjustments": [], "patterns": {}, "suggestions": []}');
            aiData.suggestions.splice(index, 1);
            localStorage.setItem('priceAIData', JSON.stringify(aiData));
            loadAISettings();
        }
        
        function generateSampleAIData() {
            if (!confirm('Generate 10 sample AI adjustments for testing?')) return;
            
            const aiData = JSON.parse(localStorage.getItem('priceAIData') || '{"adjustments": [], "patterns": {}, "suggestions": []}');
            
            // Sample groups and days
            const groups = ['B1', 'B2', 'D', 'E1', 'E2', 'F', 'J1'];
            const days = [1, 2, 3, 7, 14, 30];
            const locations = ['Albufeira', 'Aeroporto de Faro'];
            
            // Generate 10 sample adjustments
            for (let i = 0; i < 10; i++) {
                const group = groups[Math.floor(Math.random() * groups.length)];
                const day = days[Math.floor(Math.random() * days.length)];
                const location = locations[Math.floor(Math.random() * locations.length)];
                const basePrice = 20 + Math.random() * 30; // 20-50â‚¬
                const adjustment = (Math.random() - 0.5) * 4; // -2 to +2â‚¬
                
                const sampleAdjustment = {
                    group: group,
                    days: day,
                    location: location,
                    originalPrice: basePrice,
                    newPrice: basePrice + adjustment,
                    timestamp: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(), // Last 7 days
                    competitorContext: {
                        lowest: basePrice - 2,
                        highest: basePrice + 5,
                        autoPrudente: basePrice
                    }
                };
                
                aiData.adjustments.push(sampleAdjustment);
            }
            
            // Save
            localStorage.setItem('priceAIData', JSON.stringify(aiData));
            
            // Refresh
            refreshAISuggestions();
            
            alert('âœ… Generated 10 sample AI adjustments! Refresh to see suggestions.');
        }
        
        function switchLocation(location) {
            const tabAlbufeira = document.getElementById('tabAlbufeira');
            const tabFaro = document.getElementById('tabFaro');
            const rulesAlbufeira = document.getElementById('rulesAlbufeira');
            const rulesFaro = document.getElementById('rulesFaro');
            
            if (location === 'albufeira') {
                tabAlbufeira.className = 'px-4 py-2 border-b-2 border-[#f4ad0f] text-[#f4ad0f] font-semibold';
                tabFaro.className = 'px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900';
                rulesAlbufeira.classList.remove('hidden');
                rulesFaro.classList.add('hidden');
            } else {
                tabFaro.className = 'px-4 py-2 border-b-2 border-[#f4ad0f] text-[#f4ad0f] font-semibold';
                tabAlbufeira.className = 'px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-900';
                rulesFaro.classList.remove('hidden');
                rulesAlbufeira.classList.add('hidden');
            }
        }
        
        function initializeAutomatedRules() {
            createGroupRules('Albufeira', 'groupRulesAlbufeira');
            createGroupRules('Aeroporto de Faro', 'groupRulesFaro');
            // Rules are loaded per day when user clicks on day chip
        }
        
        function createGroupRules(location, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            grupos.forEach(grupo => {
                const ruleCard = document.createElement('div');
                ruleCard.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                
                ruleCard.innerHTML = `
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-900">${grupo} - ${grupoNames[grupo]}</h3>
                        </div>
                        
                        <!-- Month Selection -->
                        <div class="mb-3">
                            <span class="text-xs text-gray-600 mb-1 block">Select month:</span>
                            <div id="monthsChips_${location}_${grupo}" class="flex flex-wrap gap-1">
                                <!-- Month chips will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Days Selection -->
                        <div class="flex flex-wrap gap-1 mb-2">
                            <span class="text-xs text-gray-600 mr-2">Select day to configure:</span>
                            <div id="daysChips_${location}_${grupo}" class="flex flex-wrap gap-1">
                                <!-- Days chips will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Selected Month & Day Indicator -->
                        <div id="selectedDayInfo_${location}_${grupo}" class="hidden mb-2 p-2 bg-[#f4ad0f] bg-opacity-20 border border-[#f4ad0f] rounded text-xs">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold text-gray-800">
                                    Configuring: <span id="selectedMonthText_${location}_${grupo}"></span> - <span id="selectedDayText_${location}_${grupo}"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="ruleContent_${location}_${grupo}" class="hidden space-y-3">
                        <!-- Multiple Strategies -->
                        <div class="border-b pb-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-xs font-medium text-gray-700">Pricing Strategies (Priority Order)</label>
                                <div class="flex gap-1">
                                    <button onclick="showCopyStrategiesToDaysModal('${location}', '${grupo}')" class="p-2 text-[#009cb6] hover:bg-[#009cb6] hover:bg-opacity-10 rounded transition-colors" title="Copy strategies to other days">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                    </button>
                                    <button onclick="addStrategy('${location}', '${grupo}')" class="p-2 text-[#009cb6] hover:bg-[#009cb6] hover:bg-opacity-10 rounded transition-colors" title="Add new strategy">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">First strategy has priority. If no price available, tries next strategy.</p>
                            <div id="strategiesList_${location}_${grupo}" class="space-y-2">
                                <!-- Strategies will be added here -->
                            </div>
                        </div>
                        
                        <!-- Strategy Configuration (shown when strategy is selected) -->
                        <div id="strategyConfig_${location}_${grupo}" class="hidden">
                            <div class="bg-blue-50 border border-blue-200 rounded p-2 mb-3 text-xs">
                                <strong>Configuring:</strong> <span id="currentStrategyName_${location}_${grupo}"></span>
                            </div>
                        
                        <!-- Follow Lowest Options -->
                        <div id="followOptions_${location}_${grupo}" class="space-y-2">
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Operation</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="diffOperation_${location}_${grupo}" value="subtract" checked class="mr-2">
                                        <span class="text-sm">âž– Subtract (decrease price)</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="diffOperation_${location}_${grupo}" value="add" class="mr-2">
                                        <span class="text-sm">âž• Add (increase price)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Difference Type</label>
                                    <select id="diffType_${location}_${grupo}" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                                        <option value="cents">Cents (â‚¬)</option>
                                        <option value="euros">Euros (â‚¬)</option>
                                        <option value="percentage">Percentage (%)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Difference Value</label>
                                    <input type="number" id="diffValue_${location}_${grupo}" step="0.01" placeholder="e.g. 0.50" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Follow Suppliers Options -->
                        <div id="suppliersOptions_${location}_${grupo}" class="hidden space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-2">Select Suppliers to Follow</label>
                                <div class="max-h-48 overflow-y-auto border border-gray-300 rounded p-2 bg-white">
                                    <div id="suppliersList_${location}_${grupo}" class="space-y-1">
                                        <!-- Suppliers checkboxes will be generated here -->
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Select one or more suppliers. Price will follow the lowest among selected.</p>
                            </div>
                            
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Operation</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="supplierDiffOperation_${location}_${grupo}" value="subtract" checked class="mr-2">
                                        <span class="text-sm">âž– Subtract (decrease price)</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="supplierDiffOperation_${location}_${grupo}" value="add" class="mr-2">
                                        <span class="text-sm">âž• Add (increase price)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Difference Type</label>
                                    <select id="supplierDiffType_${location}_${grupo}" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                                        <option value="cents">Cents (â‚¬)</option>
                                        <option value="euros">Euros (â‚¬)</option>
                                        <option value="percentage">Percentage (%)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Difference Value</label>
                                    <input type="number" id="supplierDiffValue_${location}_${grupo}" step="0.01" value="0.50" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fixed Margin Options -->
                        <div id="marginOptions_${location}_${grupo}" class="hidden space-y-2">
                            <div class="mb-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Operation</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="marginOperation_${location}_${grupo}" value="subtract" checked class="mr-2">
                                        <span class="text-sm">âž– Subtract (decrease price)</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="marginOperation_${location}_${grupo}" value="add" class="mr-2">
                                        <span class="text-sm">âž• Add (increase price)</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Margin %</label>
                                <input type="number" id="margin_${location}_${grupo}" step="0.1" value="15" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                                <p class="text-xs text-gray-500 mt-1">Margin will be subtracted or added to the base price</p>
                            </div>
                        </div>
                        
                        <!-- Fixed Price Options -->
                        <div id="fixedOptions_${location}_${grupo}" class="hidden">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Fixed Price (â‚¬)</label>
                            <input type="number" id="fixedPrice_${location}_${grupo}" step="0.01" value="50.00" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                        </div>
                        
                        <!-- Minimum Prices by Day and Month -->
                        <div class="border-t pt-3 mt-3">
                            <label class="block text-xs font-medium text-gray-700 mb-2">Minimum Prices (Optional)</label>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <label class="text-gray-600">Min Price/Day (â‚¬)</label>
                                    <input type="number" id="minPriceDay_${location}_${grupo}" step="0.01" placeholder="e.g. 25.00" class="w-full px-2 py-1 text-sm border border-gray-300 rounded mt-1">
                                </div>
                                <div>
                                    <label class="text-gray-600">Min Price/Month (â‚¬)</label>
                                    <input type="number" id="minPriceMonth_${location}_${grupo}" step="0.01" placeholder="e.g. 600.00" class="w-full px-2 py-1 text-sm border border-gray-300 rounded mt-1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- SAVE BUTTON FOR THIS SPECIFIC DAY -->
                        <div class="border-t pt-3 mt-3">
                            <button 
                                onclick="saveCurrentDayConfiguration('${location}', '${grupo}')" 
                                class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded transition-colors shadow">
                                ðŸ’¾ Save Configuration for This Day
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">
                                This will save the configuration for the currently selected month and day only
                            </p>
                        </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(ruleCard);
                
                // Generate months chips
                generateMonthsChips(location, grupo);
                
                // Generate days chips
                generateDaysChips(location, grupo);
                
                // Generate suppliers checkboxes
                generateSuppliersCheckboxes(location, grupo);
            });
        }
        
        function generateMonthsChips(location, grupo) {
            const container = document.getElementById(`monthsChips_${location}_${grupo}`);
            if (!container) return;
            
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            container.innerHTML = '';
            months.forEach((month, index) => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'px-2 py-1 text-xs border border-gray-300 rounded hover:border-[#009cb6] transition-colors';
                chip.textContent = month.substring(0, 3); // Jan, Feb, Mar...
                chip.dataset.location = location;
                chip.dataset.grupo = grupo;
                chip.dataset.month = index + 1; // 1-12
                chip.dataset.monthName = month;
                chip.dataset.selected = 'false';
                
                chip.onclick = function() {
                    selectMonth(location, grupo, index + 1, month, this);
                };
                
                container.appendChild(chip);
            });
        }
        
        function selectMonth(location, grupo, monthNumber, monthName, chipElement) {
            // Deselect all month chips for this group
            const allMonthChips = document.querySelectorAll(`button[data-location="${location}"][data-grupo="${grupo}"][data-month]`);
            allMonthChips.forEach(chip => {
                chip.dataset.selected = 'false';
                chip.className = 'px-2 py-1 text-xs border border-gray-300 rounded hover:border-[#009cb6] transition-colors';
            });
            
            // Select clicked chip (azul - cor do UI)
            chipElement.dataset.selected = 'true';
            chipElement.className = 'px-2 py-1 text-xs border border-[#009cb6] bg-[#009cb6] text-white font-semibold rounded';
            
            // IMPORTANT: Clear day selection when changing month
            const allDayChips = document.querySelectorAll(`button[data-location="${location}"][data-grupo="${grupo}"][data-day]`);
            allDayChips.forEach(chip => {
                chip.dataset.selected = 'false';
                chip.className = 'px-2 py-0.5 text-xs border border-gray-300 rounded hover:border-[#f4ad0f] transition-colors';
            });
            
            // Hide rule content and selected day info
            const ruleContent = document.getElementById(`ruleContent_${location}_${grupo}`);
            if (ruleContent) {
                ruleContent.classList.add('hidden');
            }
            const dayInfo = document.getElementById(`selectedDayInfo_${location}_${grupo}`);
            if (dayInfo) {
                dayInfo.classList.add('hidden');
            }
            
            console.log(`ðŸ“… Month changed to ${monthName} for ${location}/${grupo} - day selection cleared`);
        }
        
        function getCurrentSelectedMonth(location, grupo) {
            const selectedChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-month][data-selected="true"]`);
            if (!selectedChip) return null;
            return {
                number: parseInt(selectedChip.dataset.month),
                name: selectedChip.dataset.monthName
            };
        }
        
        function getSelectedMonth(location, grupo) {
            const selectedChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-month][data-selected="true"]`);
            if (!selectedChip) return null;
            
            return {
                number: parseInt(selectedChip.dataset.month),
                name: selectedChip.dataset.monthName
            };
        }
        
        function generateDaysChips(location, grupo) {
            const container = document.getElementById(`daysChips_${location}_${grupo}`);
            if (!container) return;
            
            container.innerHTML = '';
            availableDays.forEach(day => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'px-2 py-0.5 text-xs border border-gray-300 rounded hover:border-[#f4ad0f] transition-colors';
                chip.textContent = `${day}d`;
                chip.dataset.location = location;
                chip.dataset.grupo = grupo;
                chip.dataset.day = day;
                chip.dataset.selected = 'false';
                
                chip.onclick = function() {
                    const selectedMonth = getSelectedMonth(location, grupo);
                    if (selectedMonth) {
                        selectDayChip(location, grupo, day, this, selectedMonth);
                    } else {
                        alert('âš ï¸ Please select a month first!');
                    }
                };
                
                container.appendChild(chip);
            });
        }
        
        function selectDayChip(location, grupo, day, chipElement, selectedMonth) {
            console.log(`\n${'='.repeat(80)}`);
            console.log(`ðŸ–±ï¸ CLICKED DAY CHIP: ${location}/${grupo}/${selectedMonth.name}/${day}d`);
            console.log(`${'='.repeat(80)}`);
            
            // Deselect all day chips
            const allDayChips = document.querySelectorAll(`button[data-location="${location}"][data-grupo="${grupo}"][data-day]`);
            allDayChips.forEach(chip => {
                chip.dataset.selected = 'false';
                chip.className = 'px-2 py-0.5 text-xs border border-gray-300 rounded hover:border-[#f4ad0f] transition-colors';
            });
            
            // Select clicked chip (amarelo - cor do UI)
            chipElement.dataset.selected = 'true';
            chipElement.className = 'px-2 py-0.5 text-xs border border-[#f4ad0f] bg-[#f4ad0f] bg-opacity-20 text-gray-900 font-semibold rounded';
            
            // Show selected month & day info
            const dayInfo = document.getElementById(`selectedDayInfo_${location}_${grupo}`);
            const monthText = document.getElementById(`selectedMonthText_${location}_${grupo}`);
            const dayText = document.getElementById(`selectedDayText_${location}_${grupo}`);
            if (dayInfo && monthText && dayText) {
                dayInfo.classList.remove('hidden');
                monthText.textContent = selectedMonth.name;
                dayText.textContent = `${day} day(s)`;
            }
            
            // Show rule content
            const ruleContent = document.getElementById(`ruleContent_${location}_${grupo}`);
            if (ruleContent) {
                ruleContent.classList.remove('hidden');
            }
            
            // DEBUG: Check what's saved
            const saved = localStorage.getItem('automatedPriceRules');
            if (saved) {
                const rules = JSON.parse(saved);
                console.log(`ðŸ“¦ Full localStorage for ${location}/${grupo}:`, rules[location]?.[grupo]);
                console.log(`ðŸ“… Month ${selectedMonth.number} data:`, rules[location]?.[grupo]?.months?.[selectedMonth.number]);
                console.log(`ðŸ“† Day ${day} data:`, rules[location]?.[grupo]?.months?.[selectedMonth.number]?.days?.[day]);
                console.log(`ðŸ“‹ Strategies:`, rules[location]?.[grupo]?.months?.[selectedMonth.number]?.days?.[day]?.strategies);
            }
            
            // REBUILD fields with unique IDs for this month/day
            rebuildFieldsForDay(location, grupo, selectedMonth.number, day);
            console.log(`${'='.repeat(80)}\n`);
        }
        
        // REBUILD all fields with unique IDs for this specific month/day
        function rebuildFieldsForDay(location, grupo, month, day) {
            console.log(`ðŸ”¨ REBUILDING fields for ${location}/${grupo}/${month}/${day}`);
            
            const ruleContent = document.getElementById(`ruleContent_${location}_${grupo}`);
            if (!ruleContent) {
                console.error(`âŒ ruleContent not found for ${location}_${grupo}`);
                return;
            }
            
            // Get saved configuration for this day
            const saved = localStorage.getItem('automatedPriceRules');
            console.log(`ðŸ’¾ localStorage data:`, saved ? 'exists' : 'null');
            
            let dayConfig = {};
            if (saved) {
                try {
                    const rules = JSON.parse(saved);
                    console.log(`ðŸ“‚ Full rules:`, rules);
                    dayConfig = rules[location]?.[grupo]?.months?.[month]?.days?.[day] || {};
                    console.log(`ðŸ“¦ Config for this day:`, dayConfig);
                } catch (e) {
                    console.error('âŒ Error parsing rules:', e);
                }
            }
            
            // COMPLETELY REBUILD the HTML with unique IDs
            const uniqueId = `${location}_${grupo}_${month}_${day}`;
            
            // Get strategies for this day (if exists)
            const strategies = dayConfig.strategies || [];
            console.log(`ðŸ“‹ Strategies for ${location}/${grupo}/${month}/${day}:`, strategies.length > 0 ? strategies : 'NONE');
            
            if (strategies.length > 0) {
                console.log(`âœ… Found ${strategies.length} strategies for ${location}/${grupo}/${month}/${day}:`);
                strategies.forEach((s, i) => {
                    console.log(`  ${i+1}. ${s.type} - ${JSON.stringify(s).substring(0, 50)}...`);
                });
            } else {
                console.log(`â„¹ï¸ No strategies found for ${location}/${grupo}/${month}/${day}`);
            }
            
            const hasStrategies = strategies.length > 0;
            
            const htmlContent = `
                <div class="space-y-4">
                    <!-- Multiple Strategies List -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-900">Pricing Strategies</label>
                                <p class="text-xs text-gray-500">Priority order - first strategy with data wins</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="showCopyStrategiesToDaysModal('${location}', '${grupo}')" 
                                        class="p-2 text-[#009cb6] hover:bg-[#009cb6] hover:bg-opacity-10 rounded transition-colors" title="Copy strategies to other days">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                                <button onclick="addNewStrategy('${location}', '${grupo}', ${month}, ${day}, '${uniqueId}')" 
                                        class="p-2 text-[#009cb6] hover:bg-[#009cb6] hover:bg-opacity-10 rounded transition-colors" title="Add new strategy">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="strategiesList_${uniqueId}" class="space-y-2 min-h-[50px] border border-dashed border-gray-300 rounded p-2">
                            ${strategies.length === 0 ? 
                                '<p class="text-xs text-gray-400 italic text-center py-4">No strategies configured. Click "Add Strategy" to create one.</p>' : 
                                strategies.map((strat, idx) => `
                                    <div class="border border-gray-300 rounded-lg p-3 bg-white mb-2">
                                        <div class="flex items-start justify-between gap-2">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-xs font-semibold text-gray-700">Priority ${idx + 1}</span>
                                                    <span class="text-xs px-2 py-0.5 bg-[#009cb6] bg-opacity-10 text-[#009cb6] rounded">${strat.type}</span>
                                                </div>
                                                <p class="text-xs text-gray-600">${strat.type === 'follow_lowest' ? `Follow lowest + ${strat.diffValue || 0} ${strat.diffType || 'cents'}` : strat.type}</p>
                                            </div>
                                            <div class="flex gap-1">
                                                ${idx > 0 ? `<button onclick="moveStrategyUp('${location}', '${grupo}', ${month}, ${day}, ${idx})" class="p-1 text-gray-500 hover:text-[#009cb6] transition-colors" title="Move up"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg></button>` : ''}
                                                ${idx < strategies.length - 1 ? `<button onclick="moveStrategyDown('${location}', '${grupo}', ${month}, ${day}, ${idx})" class="p-1 text-gray-500 hover:text-[#009cb6] transition-colors" title="Move down"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button>` : ''}
                                                <button onclick="deleteStrategy('${location}', '${grupo}', ${month}, ${day}, ${idx})" class="p-1 text-red-500 hover:text-red-700 transition-colors" title="Delete"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                    
                    <!-- Minimum Prices -->
                    <div class="border-t pt-3 mt-3">
                        <label class="block text-xs font-medium text-gray-700 mb-2">Minimum Prices (Optional)</label>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <label class="text-gray-600">Min Price/Day (â‚¬)</label>
                                <input type="number" id="minPriceDay_${uniqueId}" step="0.01" value="${dayConfig.minPriceDay || ''}" placeholder="e.g. 25.00" class="w-full px-2 py-1 text-sm border border-gray-300 rounded mt-1">
                            </div>
                            <div>
                                <label class="text-gray-600">Min Price/Month (â‚¬)</label>
                                <input type="number" id="minPriceMonth_${uniqueId}" step="0.01" value="${dayConfig.minPriceMonth || ''}" placeholder="e.g. 600.00" class="w-full px-2 py-1 text-sm border border-gray-300 rounded mt-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Auto-save indicator -->
                    <div class="border-t border-gray-200 pt-2 mt-2">
                        <p class="text-xs text-gray-500 text-center flex items-center justify-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Changes save automatically
                        </p>
                    </div>
                </div>
            `;
            
            console.log(`ðŸ“ HTML content length: ${htmlContent.length} characters`);
            console.log(`ðŸ” Contains "Copy to Other Days":`, htmlContent.includes('Copy to Other Days'));
            
            ruleContent.innerHTML = htmlContent;
            
            // Generate suppliers list if follow_suppliers strategy
            const suppliersList = document.getElementById(`suppliersList_${uniqueId}`);
            if (suppliersList) {
                const suppliers = [
                    'Hertz', 'Avis', 'Europcar', 'Budget', 'Sixt', 'Enterprise',
                    'Thrifty', 'Dollar', 'Alamo', 'National', 'Firefly', 'Goldcar',
                    'Centauro', 'OK Mobility', 'Record Go', 'Surprice', 'Interrent',
                    'Green Motion', 'Keddy', 'Rhodium', 'Flizzr', 'Ace'
                ].sort();
                
                suppliers.forEach(supplier => {
                    const isChecked = dayConfig.selectedSuppliers && dayConfig.selectedSuppliers.includes(supplier);
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-2 p-1 hover:bg-gray-100 rounded cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" value="${supplier}" ${isChecked ? 'checked' : ''} 
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded supplier-checkbox-${uniqueId}">
                        <span class="text-xs">${supplier}</span>
                    `;
                    suppliersList.appendChild(label);
                });
            }
            
            // Add change listeners for auto-save
            const allInputs = ruleContent.querySelectorAll('input, select');
            allInputs.forEach(input => {
                input.addEventListener('change', () => {
                    console.log(`ðŸ“ Field changed - saving ${location}/${grupo}/${month}/${day}`);
                    saveConfigFromFields(location, grupo, month, day, uniqueId);
                });
            });
            
            console.log(`âœ… Fields rebuilt with unique ID: ${uniqueId}`);
            console.log(`ðŸ“‹ Strategies rendered directly in template: ${strategies.length}`);
            
            // Verify button exists
            setTimeout(() => {
                const copyButton = document.querySelector(`button[onclick*="showCopyToDaysModal"]`);
                console.log(`ðŸ” Copy to Other Days button exists:`, copyButton ? 'YES' : 'NO');
                if (!copyButton) {
                    console.error('âŒ Copy button not found in DOM!');
                }
            }, 200);
        }
        
        function getStrategyDescription(strat) {
            if (strat.type === 'follow_lowest') {
                return `Follow lowest + ${strat.diffValue} ${strat.diffType}`;
            } else if (strat.type === 'follow_suppliers') {
                const method = strat.calcMethod === 'average' ? 'average' : 'lowest';
                const supplierNames = strat.suppliers?.slice(0, 2).join(', ') || 'suppliers';
                const moreCount = strat.suppliers?.length > 2 ? ` +${strat.suppliers.length - 2}` : '';
                return `Follow ${method} of ${supplierNames}${moreCount} + ${strat.diffValue} ${strat.diffType}`;
            } else if (strat.type === 'fixed_margin') {
                return `Fixed margin ${strat.margin}%`;
            } else if (strat.type === 'fixed_price') {
                return `Fixed price â‚¬${strat.fixedPrice}`;
            }
            return strat.type;
        }
        
        // Add new strategy
        function addNewStrategy(location, grupo, month, day, uniqueId) {
            // Create modal
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto';
            modal.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Add New Strategy</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Strategy Type</label>
                        <div class="grid grid-cols-2 gap-2">
                            <!-- Follow Lowest -->
                            <label class="flex flex-col items-center justify-center gap-2 p-3 border-2 rounded-lg cursor-pointer transition-all hover:border-[#009cb6] strategy-type-option border-[#009cb6] bg-[#009cb6] bg-opacity-5" data-value="follow_lowest" title="Follow Lowest Price">
                                <input type="radio" name="strategyTypeRadio" value="follow_lowest" checked class="hidden">
                                <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                <span class="text-xs text-center font-medium">Lowest</span>
                            </label>
                            
                            <!-- Follow Suppliers -->
                            <label class="flex flex-col items-center justify-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer transition-all hover:border-[#009cb6] strategy-type-option" data-value="follow_suppliers" title="Follow Specific Suppliers">
                                <input type="radio" name="strategyTypeRadio" value="follow_suppliers" class="hidden">
                                <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                                <span class="text-xs text-center font-medium">Suppliers</span>
                            </label>
                            
                            <!-- Fixed Margin -->
                            <label class="flex flex-col items-center justify-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer transition-all hover:border-[#009cb6] strategy-type-option" data-value="fixed_margin" title="Fixed Margin %">
                                <input type="radio" name="strategyTypeRadio" value="fixed_margin" class="hidden">
                                <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                <span class="text-xs text-center font-medium">Margin %</span>
                            </label>
                            
                            <!-- Fixed Price -->
                            <label class="flex flex-col items-center justify-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer transition-all hover:border-[#009cb6] strategy-type-option" data-value="fixed_price" title="Fixed Price">
                                <input type="radio" name="strategyTypeRadio" value="fixed_price" class="hidden">
                                <svg class="w-8 h-8 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-xs text-center font-medium">Fixed â‚¬</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="newStratConfig"></div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancel
                    </button>
                    <button onclick="saveNewStrategy('${location}', '${grupo}', ${month}, ${day}, '${uniqueId}')" class="px-4 py-2 bg-[#009cb6] text-white rounded hover:bg-[#007a91] flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add Strategy
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Setup type change listeners for labels (since radio is hidden)
            document.querySelectorAll('.strategy-type-option').forEach(label => {
                label.addEventListener('click', () => {
                    // Get the radio inside
                    const radio = label.querySelector('input[name="strategyTypeRadio"]');
                    if (radio) {
                        radio.checked = true;
                    }
                    
                    // Update border highlight
                    document.querySelectorAll('.strategy-type-option').forEach(opt => {
                        opt.classList.remove('border-[#009cb6]', 'bg-[#009cb6]', 'bg-opacity-5');
                        opt.classList.add('border-gray-300');
                    });
                    label.classList.remove('border-gray-300');
                    label.classList.add('border-[#009cb6]', 'bg-[#009cb6]', 'bg-opacity-5');
                    
                    updateNewStrategyConfig();
                });
            });
            
            // Initial config
            updateNewStrategyConfig();
        }
        
        function updateNewStrategyConfig() {
            const type = document.querySelector('input[name="strategyTypeRadio"]:checked')?.value || 'follow_lowest';
            const config = document.getElementById('newStratConfig');
            
            if (type === 'follow_lowest') {
                config.innerHTML = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium mb-2">Operation</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="newDiffOperation" value="subtract" checked class="mr-2">
                                <span class="text-sm">âž– Subtract</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="newDiffOperation" value="add" class="mr-2">
                                <span class="text-sm">âž• Add</span>
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-xs mb-1">Type</label><select id="newDiffType" class="w-full px-2 py-1 border rounded text-sm"><option value="cents">Cents</option><option value="euros">Euros</option><option value="percentage">%</option></select></div>
                        <div><label class="block text-xs mb-1">Value</label><input type="number" id="newDiffValue" step="0.01" class="w-full px-2 py-1 border rounded text-sm"></div>
                    </div>
                `;
            } else if (type === 'follow_suppliers') {
                const suppliers = [
                    'Hertz', 'Avis', 'Europcar', 'Budget', 'Sixt', 'Enterprise',
                    'Thrifty', 'Dollar', 'Alamo', 'National', 'Firefly', 'Goldcar',
                    'Centauro', 'OK Mobility', 'Record Go', 'Surprice', 'Interrent',
                    'Green Motion', 'Keddy', 'Rhodium', 'Flizzr', 'Ace'
                ].sort();
                
                config.innerHTML = `
                    <div>
                        <label class="block text-xs font-medium mb-2">Select Suppliers</label>
                        <div class="max-h-48 overflow-y-auto border border-gray-300 rounded p-2 bg-gray-50 mb-3">
                            <div class="space-y-1">
                                ${suppliers.map(s => `
                                    <label class="flex items-center gap-2 p-1 hover:bg-white rounded cursor-pointer">
                                        <input type="checkbox" value="${s}" class="new-supplier-checkbox w-3 h-3 text-[#009cb6] border-gray-300 rounded">
                                        <span class="text-xs">${s}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-medium mb-2">Calculation Method</label>
                            <div class="space-y-1">
                                <label class="flex items-center gap-2 p-2 border border-gray-300 rounded hover:border-[#009cb6] cursor-pointer">
                                    <input type="radio" name="supplierCalcMethod" value="lowest" checked class="w-3 h-3 text-[#009cb6]">
                                    <span class="text-xs">Follow Lowest (minimum price)</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-300 rounded hover:border-[#009cb6] cursor-pointer">
                                    <input type="radio" name="supplierCalcMethod" value="average" class="w-3 h-3 text-[#009cb6]">
                                    <span class="text-xs">Follow Average (mean price)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-xs font-medium mb-2">Operation</label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="newSupplierDiffOperation" value="subtract" checked class="mr-2">
                                    <span class="text-sm">âž– Subtract</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="newSupplierDiffOperation" value="add" class="mr-2">
                                    <span class="text-sm">âž• Add</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs mb-1">Difference Type</label><select id="newDiffType" class="w-full px-2 py-1 border rounded text-sm"><option value="cents">Cents</option><option value="euros">Euros</option><option value="percentage">%</option></select></div>
                            <div><label class="block text-xs mb-1">Difference Value</label><input type="number" id="newDiffValue" step="0.01" class="w-full px-2 py-1 border rounded text-sm"></div>
                        </div>
                    </div>
                `;
            } else if (type === 'fixed_margin') {
                config.innerHTML = `
                    <div class="mb-3">
                        <label class="block text-xs font-medium mb-2">Operation</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="newMarginOperation" value="subtract" checked class="mr-2">
                                <span class="text-sm">âž– Subtract</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="newMarginOperation" value="add" class="mr-2">
                                <span class="text-sm">âž• Add</span>
                            </label>
                        </div>
                    </div>
                    <div><label class="block text-xs mb-1">Margin %</label><input type="number" id="newMargin" step="0.1" class="w-full px-2 py-1 border rounded text-sm"></div>
                `;
            } else if (type === 'fixed_price') {
                config.innerHTML = `<div><label class="block text-xs mb-1">Fixed Price (â‚¬)</label><input type="number" id="newFixedPrice" step="0.01" class="w-full px-2 py-1 border rounded text-sm"></div>`;
            }
        }
        
        function saveNewStrategy(location, grupo, month, day, uniqueId) {
            const type = document.querySelector('input[name="strategyTypeRadio"]:checked')?.value || 'follow_lowest';
            const strategy = { type };
            
            if (type === 'follow_lowest') {
                strategy.diffType = document.getElementById('newDiffType').value;
                strategy.diffValue = parseFloat(document.getElementById('newDiffValue').value) || 0;
                strategy.diffOperation = document.querySelector('input[name="newDiffOperation"]:checked')?.value || 'subtract';
            } else if (type === 'follow_suppliers') {
                // Get checked suppliers
                const selectedSuppliers = [];
                document.querySelectorAll('.new-supplier-checkbox:checked').forEach(cb => {
                    selectedSuppliers.push(cb.value);
                });
                
                if (selectedSuppliers.length === 0) {
                    alert('âš ï¸ Please select at least one supplier!');
                    return;
                }
                
                strategy.selectedSuppliers = selectedSuppliers;
                strategy.suppliers = selectedSuppliers;
                strategy.calcMethod = document.querySelector('input[name="supplierCalcMethod"]:checked').value;
                strategy.supplierDiffType = document.getElementById('newDiffType').value;
                strategy.supplierDiffValue = parseFloat(document.getElementById('newDiffValue').value) || 0;
                strategy.supplierDiffOperation = document.querySelector('input[name="newSupplierDiffOperation"]:checked')?.value || 'subtract';
            } else if (type === 'fixed_margin') {
                strategy.margin = parseFloat(document.getElementById('newMargin').value) || 0;
                strategy.marginOperation = document.querySelector('input[name="newMarginOperation"]:checked')?.value || 'subtract';
            } else if (type === 'fixed_price') {
                strategy.fixedPrice = parseFloat(document.getElementById('newFixedPrice').value) || 0;
            }
            
            // Get existing config
            const saved = localStorage.getItem('automatedPriceRules');
            const rules = saved ? JSON.parse(saved) : {};
            
            if (!rules[location]) rules[location] = {};
            if (!rules[location][grupo]) rules[location][grupo] = { months: {} };
            if (!rules[location][grupo].months[month]) rules[location][grupo].months[month] = { days: {} };
            if (!rules[location][grupo].months[month].days[day]) rules[location][grupo].months[month].days[day] = {};
            if (!rules[location][grupo].months[month].days[day].strategies) rules[location][grupo].months[month].days[day].strategies = [];
            
            rules[location][grupo].months[month].days[day].strategies.push(strategy);
            console.log(`âœ… Strategy added. Total strategies: ${rules[location][grupo].months[month].days[day].strategies.length}`);
            console.log(`ðŸ“¦ Strategy data:`, strategy);
            
            // Save to localStorage and database
            localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
            
            // Save to database
            fetch('/api/price-automation/rules/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rules)
            }).then(r => r.json()).then(result => {
                if (result.ok) {
                    console.log('âœ… Strategy saved to database');
                }
            }).catch(err => {
                console.error('Error saving to database:', err);
            });
            
            // Close modal and rebuild
            document.querySelector('.fixed.inset-0').remove();
            rebuildFieldsForDay(location, grupo, month, day);
        }
        
        async function moveStrategyUp(location, grupo, month, day, index) {
            const saved = localStorage.getItem('automatedPriceRules');
            const rules = JSON.parse(saved);
            const strategies = rules[location][grupo].months[month].days[day].strategies;
            
            [strategies[index - 1], strategies[index]] = [strategies[index], strategies[index - 1]];
            localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
            
            // Save to database
            try {
                await fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
            } catch (err) {
                console.error('Error saving:', err);
            }
            
            rebuildFieldsForDay(location, grupo, month, day);
        }
        
        async function moveStrategyDown(location, grupo, month, day, index) {
            const saved = localStorage.getItem('automatedPriceRules');
            const rules = JSON.parse(saved);
            const strategies = rules[location][grupo].months[month].days[day].strategies;
            
            [strategies[index], strategies[index + 1]] = [strategies[index + 1], strategies[index]];
            localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
            
            // Save to database
            try {
                await fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
            } catch (err) {
                console.error('Error saving:', err);
            }
            
            rebuildFieldsForDay(location, grupo, month, day);
        }
        
        async function deleteStrategy(location, grupo, month, day, index) {
            if (!confirm('Delete this strategy?')) return;
            
            const saved = localStorage.getItem('automatedPriceRules');
            const rules = JSON.parse(saved);
            rules[location][grupo].months[month].days[day].strategies.splice(index, 1);
            localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
            
            // Save to database
            try {
                await fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
            } catch (err) {
                console.error('Error saving:', err);
            }
            
            rebuildFieldsForDay(location, grupo, month, day);
        }
        
        // Update visibility of strategy fields
        function updateStrategyFieldsNew(uniqueId, location, grupo, month, day) {
            const strategy = document.getElementById(`strategy_${uniqueId}`).value;
            
            document.getElementById(`followOptions_${uniqueId}`).classList.add('hidden');
            document.getElementById(`suppliersOptions_${uniqueId}`).classList.add('hidden');
            document.getElementById(`marginOptions_${uniqueId}`).classList.add('hidden');
            document.getElementById(`fixedOptions_${uniqueId}`).classList.add('hidden');
            
            if (strategy === 'follow_lowest') {
                document.getElementById(`followOptions_${uniqueId}`).classList.remove('hidden');
            } else if (strategy === 'follow_suppliers') {
                document.getElementById(`suppliersOptions_${uniqueId}`).classList.remove('hidden');
            } else if (strategy === 'fixed_margin') {
                document.getElementById(`marginOptions_${uniqueId}`).classList.remove('hidden');
            } else if (strategy === 'fixed_price') {
                document.getElementById(`fixedOptions_${uniqueId}`).classList.remove('hidden');
            }
            
            // Save on strategy change
            saveConfigFromFields(location, grupo, month, day, uniqueId);
        }
        
        // Save configuration from the current fields
        async function saveConfigFromFields(location, grupo, month, day, uniqueId) {
            const saved = localStorage.getItem('automatedPriceRules');
            let rules = saved ? JSON.parse(saved) : {};
            
            // Initialize structure
            if (!rules[location]) rules[location] = {};
            if (!rules[location][grupo]) rules[location][grupo] = { months: {} };
            if (!rules[location][grupo].months[month]) rules[location][grupo].months[month] = { days: {} };
            
            // Read values from fields with unique IDs
            const strategy = document.getElementById(`strategy_${uniqueId}`)?.value;
            
            if (!strategy) {
                console.error(`Strategy field not found for ${uniqueId}`);
                return;
            }
            
            // Get selected suppliers
            const selectedSuppliers = [];
            const supplierCheckboxes = document.querySelectorAll(`.supplier-checkbox-${uniqueId}:checked`);
            supplierCheckboxes.forEach(cb => selectedSuppliers.push(cb.value));
            
            rules[location][grupo].months[month].days[day] = {
                strategy: strategy,
                diffType: document.getElementById(`diffType_${uniqueId}`)?.value || 'cents',
                diffValue: parseFloat(document.getElementById(`diffValue_${uniqueId}`)?.value) || 0,
                selectedSuppliers: selectedSuppliers,
                supplierDiffType: document.getElementById(`supplierDiffType_${uniqueId}`)?.value || 'cents',
                supplierDiffValue: parseFloat(document.getElementById(`supplierDiffValue_${uniqueId}`)?.value) || 0,
                margin: parseFloat(document.getElementById(`margin_${uniqueId}`)?.value) || 0,
                fixedPrice: parseFloat(document.getElementById(`fixedPrice_${uniqueId}`)?.value) || 0,
                minPriceDay: parseFloat(document.getElementById(`minPriceDay_${uniqueId}`)?.value) || null,
                minPriceMonth: parseFloat(document.getElementById(`minPriceMonth_${uniqueId}`)?.value) || null
            };
            
            console.log(`ðŸ’¾ Saving for ${location}/${grupo}/${month}/${day}:`, rules[location][grupo].months[month].days[day]);
            
            try {
                // Save to database
                const response = await fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
                
                if (response.ok) {
                    localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
                    console.log(`âœ… Saved successfully`);
                }
            } catch (err) {
                console.error('Error saving:', err);
                localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
            }
        }
        
        function loadDayConfiguration(location, grupo, month, day) {
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            console.log(`ðŸ“‚ Loading config for: ${location}/${grupo}/${month}/${day}`);
            console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`);
            
            // NOT NEEDED ANYMORE - rebuildFieldsForDay handles everything
            // ALWAYS reset fields first to clear previous configuration
            // resetDayConfiguration(location, grupo);
            
            const saved = localStorage.getItem('automatedPriceRules');
            if (!saved) {
                console.log(`âŒ No saved rules in localStorage`);
                console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
                return;
            }
            
            try {
                const rules = JSON.parse(saved);
                console.log(`ðŸ“¦ Full rules object:`, rules);
                
                // Check step by step
                console.log(`  â†’ rules[${location}] exists?`, !!rules[location]);
                if (rules[location]) {
                    console.log(`  â†’ rules[${location}][${grupo}] exists?`, !!rules[location][grupo]);
                    if (rules[location][grupo]) {
                        console.log(`  â†’ rules[${location}][${grupo}].months exists?`, !!rules[location][grupo].months);
                        if (rules[location][grupo].months) {
                            console.log(`  â†’ rules[${location}][${grupo}].months[${month}] exists?`, !!rules[location][grupo].months[month]);
                            if (rules[location][grupo].months[month]) {
                                console.log(`  â†’ rules[${location}][${grupo}].months[${month}].days exists?`, !!rules[location][grupo].months[month].days);
                                if (rules[location][grupo].months[month].days) {
                                    const availableDays = Object.keys(rules[location][grupo].months[month].days);
                                    console.log(`  â†’ Available days in month ${month}:`, availableDays);
                                }
                            }
                        }
                    }
                }
                
                const dayRule = rules[location]?.[grupo]?.months?.[month]?.days?.[day];
                
                if (dayRule && dayRule.strategy) {
                    console.log(`âœ…âœ…âœ… CONFIGURATION FOUND for ${location}/${grupo}/${month}/${day}`);
                    console.log(`   Config:`, JSON.stringify(dayRule, null, 2));
                    
                    // Load existing configuration for this day
                    const strategyEl = document.getElementById(`strategy_${location}_${grupo}`);
                    if (strategyEl) {
                        console.log(`   â†’ Loading strategy: ${dayRule.strategy}`);
                        strategyEl.value = dayRule.strategy;
                        updateStrategyFields(location, grupo);
                        
                        // Load all fields with explicit logging
                        if (dayRule.diffType) {
                            console.log(`   â†’ Loading diffType: ${dayRule.diffType}`);
                            document.getElementById(`diffType_${location}_${grupo}`).value = dayRule.diffType;
                        }
                        if (dayRule.diffValue !== undefined && dayRule.diffValue !== null) {
                            console.log(`   â†’ Loading diffValue: ${dayRule.diffValue}`);
                            document.getElementById(`diffValue_${location}_${grupo}`).value = dayRule.diffValue;
                        }
                        if (dayRule.margin !== undefined && dayRule.margin !== null) {
                            document.getElementById(`margin_${location}_${grupo}`).value = dayRule.margin;
                        }
                        if (dayRule.fixedPrice !== undefined && dayRule.fixedPrice !== null) {
                            document.getElementById(`fixedPrice_${location}_${grupo}`).value = dayRule.fixedPrice;
                        }
                        if (dayRule.minPriceDay !== undefined && dayRule.minPriceDay !== null) {
                            document.getElementById(`minPriceDay_${location}_${grupo}`).value = dayRule.minPriceDay;
                        }
                        if (dayRule.minPriceMonth !== undefined && dayRule.minPriceMonth !== null) {
                            document.getElementById(`minPriceMonth_${location}_${grupo}`).value = dayRule.minPriceMonth;
                        }
                        
                        // Load suppliers
                        if (dayRule.selectedSuppliers && dayRule.selectedSuppliers.length > 0) {
                            // Clear all checkboxes first (already done in reset, but be explicit)
                            const allCheckboxes = document.querySelectorAll(`input[type="checkbox"][data-location="${location}"][data-grupo="${grupo}"]`);
                            allCheckboxes.forEach(cb => cb.checked = false);
                            
                            // Check selected ones
                            dayRule.selectedSuppliers.forEach(supplier => {
                                const checkbox = document.getElementById(`supplier_${location}_${grupo}_${supplier.replace(/\s+/g, '_')}`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        if (dayRule.supplierDiffType) document.getElementById(`supplierDiffType_${location}_${grupo}`).value = dayRule.supplierDiffType;
                        if (dayRule.supplierDiffValue !== undefined && dayRule.supplierDiffValue !== null) {
                            document.getElementById(`supplierDiffValue_${location}_${grupo}`).value = dayRule.supplierDiffValue;
                        }
                    }
                } else {
                    console.log(`ðŸ“­ NO CONFIGURATION for ${location}/${grupo}/${month}/${day}`);
                    console.log(`   Fields should be empty/default`);
                }
                console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
            } catch (e) {
                console.error('âŒ Error loading day configuration:', e);
                console.log(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);
            }
        }
        
        function resetDayConfiguration(location, grupo) {
            console.log(`ðŸ§¹ðŸ§¹ðŸ§¹ AGGRESSIVE RESET for ${location}/${grupo}`);
            
            const ruleContent = document.getElementById(`ruleContent_${location}_${grupo}`);
            if (!ruleContent) {
                console.error(`âŒ ruleContent not found!`);
                return;
            }
            
            // FORCE reset strategy to default
            const strategyEl = document.getElementById(`strategy_${location}_${grupo}`);
            if (strategyEl) {
                strategyEl.value = 'follow_lowest';
                console.log(`  â†’ Strategy FORCED to: follow_lowest`);
            }
            
            // FORCE clear ALL inputs - be very aggressive
            const allInputs = ruleContent.querySelectorAll('input');
            allInputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else if (input.type === 'number' || input.type === 'text') {
                    input.value = '';
                }
                console.log(`  â†’ Input ${input.id} cleared:`, input.value);
            });
            
            // FORCE reset ALL selects
            const allSelects = ruleContent.querySelectorAll('select');
            allSelects.forEach(select => {
                if (select.id !== `strategy_${location}_${grupo}`) {
                    if (select.options.length > 0) {
                        select.selectedIndex = 0;
                    }
                    console.log(`  â†’ Select ${select.id} reset to index 0`);
                }
            });
            
            // Update strategy fields visibility
            updateStrategyFields(location, grupo);
            
            console.log(`âœ…âœ…âœ… AGGRESSIVE RESET COMPLETE for ${location}/${grupo}`);
        }
        
        function copyFromDay(location, grupo) {
            const currentDay = getCurrentSelectedDay(location, grupo);
            if (!currentDay) {
                alert('No day selected');
                return;
            }
            
            // Show dialog to select day to copy from
            const daysList = availableDays.filter(d => d !== currentDay).join(', ');
            const sourceDayStr = prompt(`Copy configuration from which day?\nAvailable: ${daysList}`);
            
            if (sourceDayStr) {
                const sourceDay = parseInt(sourceDayStr);
                if (availableDays.includes(sourceDay)) {
                    const saved = localStorage.getItem('automatedPriceRules');
                    if (saved) {
                        try {
                            const rules = JSON.parse(saved);
                            const sourceDayRule = rules[location]?.[grupo]?.days?.[sourceDay];
                            
                            if (sourceDayRule) {
                                // Copy configuration to current day
                                loadDayConfigurationFromObject(location, grupo, sourceDayRule);
                                alert(`âœ… Configuration copied from ${sourceDay}d to ${currentDay}d`);
                            } else {
                                alert(`âš ï¸ No configuration found for ${sourceDay}d`);
                            }
                        } catch (e) {
                            alert('Error copying configuration');
                        }
                    }
                } else {
                    alert('Invalid day number');
                }
            }
        }
        
        function loadDayConfigurationFromObject(location, grupo, config) {
            const strategyEl = document.getElementById(`strategy_${location}_${grupo}`);
            if (strategyEl && config.strategy) {
                strategyEl.value = config.strategy;
                updateStrategyFields(location, grupo);
                
                if (config.diffType) document.getElementById(`diffType_${location}_${grupo}`).value = config.diffType;
                if (config.diffValue) document.getElementById(`diffValue_${location}_${grupo}`).value = config.diffValue;
                if (config.margin) document.getElementById(`margin_${location}_${grupo}`).value = config.margin;
                if (config.fixedPrice) document.getElementById(`fixedPrice_${location}_${grupo}`).value = config.fixedPrice;
                if (config.minPriceDay) document.getElementById(`minPriceDay_${location}_${grupo}`).value = config.minPriceDay;
                if (config.minPriceMonth) document.getElementById(`minPriceMonth_${location}_${grupo}`).value = config.minPriceMonth;
                
                if (config.selectedSuppliers) {
                    const allCheckboxes = document.querySelectorAll(`input[type="checkbox"][data-location="${location}"][data-grupo="${grupo}"]`);
                    allCheckboxes.forEach(cb => cb.checked = false);
                    config.selectedSuppliers.forEach(supplier => {
                        const checkbox = document.getElementById(`supplier_${location}_${grupo}_${supplier.replace(/\s+/g, '_')}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                if (config.supplierDiffType) document.getElementById(`supplierDiffType_${location}_${grupo}`).value = config.supplierDiffType;
                if (config.supplierDiffValue) document.getElementById(`supplierDiffValue_${location}_${grupo}`).value = config.supplierDiffValue;
            }
        }
        
        // Setup auto-save listeners for a specific group/month/day
        function setupAutoSaveListeners(location, grupo, month, day) {
            console.log(`ðŸ”§ Setting up auto-save for ${location}/${grupo}/${month}/${day}`);
            
            const ruleContent = document.getElementById(`ruleContent_${location}_${grupo}`);
            if (!ruleContent) {
                console.error(`âŒ ruleContent not found for ${location}/${grupo}`);
                return;
            }
            
            // Store the current month and day in the element's dataset for reference
            ruleContent.dataset.currentMonth = month;
            ruleContent.dataset.currentDay = day;
            
            // Remove any existing listeners by setting a flag
            if (!ruleContent.dataset.listenerConfigured) {
                // Add event delegation listener ONCE per group
                ruleContent.addEventListener('change', (e) => {
                    const target = e.target;
                    if (target.matches('input, select')) {
                        const currentMonth = parseInt(ruleContent.dataset.currentMonth);
                        const currentDay = parseInt(ruleContent.dataset.currentDay);
                        
                        console.log(`ðŸ“ Field ${target.id} changed - auto-saving ${location}/${grupo}/${currentMonth}/${currentDay}`);
                        saveConfigForGroup(location, grupo, currentMonth, currentDay);
                    }
                });
                
                ruleContent.dataset.listenerConfigured = 'true';
                console.log(`âœ… Auto-save listener configured for ${location}/${grupo}`);
            } else {
                console.log(`â„¹ï¸ Auto-save already configured, updating context to ${month}/${day}`);
            }
        }
        
        function getCurrentSelectedDay(location, grupo) {
            const selectedChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-day][data-selected="true"]`);
            return selectedChip ? parseInt(selectedChip.dataset.day) : null;
        }
        
        function getCurrentSelectedMonth(location, grupo) {
            const selectedChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-month][data-selected="true"]`);
            return selectedChip ? parseInt(selectedChip.dataset.month) : null;
        }
        
        function debugShowLocalStorage(location, grupo) {
            const rules = JSON.parse(localStorage.getItem('automatedPriceRules') || '{}');
            const currentMonth = getCurrentSelectedMonth(location, grupo);
            const currentDay = getCurrentSelectedDay(location, grupo);
            
            console.log('='.repeat(60));
            console.log('ðŸ” DEBUG LocalStorage');
            console.log('='.repeat(60));
            console.log(`Location: ${location}, Grupo: ${grupo}`);
            console.log(`Current: Month ${currentMonth}, Day ${currentDay}`);
            console.log('Full Rules:', rules);
            
            if (currentMonth && currentDay) {
                const dayData = rules[location]?.[grupo]?.months?.[currentMonth]?.days?.[currentDay];
                console.log(`\nData for Month ${currentMonth}, Day ${currentDay}:`, dayData);
                if (dayData && dayData.strategies) {
                    console.log(`âœ… Found ${dayData.strategies.length} strategies`);
                    dayData.strategies.forEach((s, i) => {
                        console.log(`  ${i+1}. ${s.type}`, s);
                    });
                } else {
                    console.log('âŒ No strategies found');
                }
            }
            console.log('='.repeat(60));
            
            alert('Check console (F12) for localStorage debug info');
        }
        
        // Show modal to copy configuration to other days
        function showCopyToDaysModal(location, grupo, sourceMonth, sourceDay) {
            console.log(`ðŸ“‹ Copying from ${location}/${grupo}/${sourceMonth}/${sourceDay}`);
            
            // Get the configuration to copy
            const saved = localStorage.getItem('automatedPriceRules');
            if (!saved) {
                alert('âš ï¸ No configuration to copy!');
                return;
            }
            
            const rules = JSON.parse(saved);
            const sourceConfig = rules[location]?.[grupo]?.months?.[sourceMonth]?.days?.[sourceDay];
            
            if (!sourceConfig) {
                alert('âš ï¸ No configuration to copy!');
                return;
            }
            
            // Create modal
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const availableDays = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30];
            
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto';
            modal.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Copy Configuration to Other Days</h3>
                    <p class="text-sm text-gray-600">
                        Copying from <strong>${monthNames[sourceMonth-1]} - ${sourceDay} day(s)</strong>
                    </p>
                </div>
                
                <!-- Select Which Strategy to Copy -->
                <div class="mb-4 bg-gray-50 border border-gray-300 rounded p-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Strategy to Copy</label>
                    ${sourceConfig.strategies && sourceConfig.strategies.length > 0 ? `
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 p-2 border border-gray-300 rounded hover:border-[#009cb6] bg-white cursor-pointer">
                                <input type="radio" name="copyStrategySelect" value="all" checked class="w-4 h-4 text-[#009cb6]">
                                <span class="text-sm font-semibold">ðŸ“¦ All Strategies (${sourceConfig.strategies.length})</span>
                            </label>
                            ${sourceConfig.strategies.map((strat, idx) => `
                                <label class="flex items-center gap-2 p-2 border border-gray-300 rounded hover:border-[#009cb6] bg-white cursor-pointer">
                                    <input type="radio" name="copyStrategySelect" value="${idx}" class="w-4 h-4 text-[#009cb6]">
                                    <div class="flex-1">
                                        <span class="text-xs font-semibold text-gray-700">Priority ${idx + 1}</span>
                                        <span class="text-xs px-2 py-0.5 ml-2 bg-[#009cb6] bg-opacity-10 text-[#009cb6] rounded">${strat.type}</span>
                                        <p class="text-xs text-gray-600 mt-1">${getStrategyDescription(strat)}</p>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    ` : `
                        <p class="text-xs text-gray-500">No strategies configured for this day</p>
                    `}
                </div>
                
                <!-- Month Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Month(s)</label>
                    <div class="flex flex-wrap gap-2">
                        ${monthNames.map((m, idx) => `
                            <button type="button" data-month="${idx+1}" 
                                    class="copy-month-chip px-3 py-1 text-xs border border-gray-300 rounded hover:border-[#009cb6] transition-colors"
                                    onclick="toggleCopyMonthChip(this)">
                                ${m}
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Days Selection -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Select Day(s)</label>
                        <div class="flex gap-2">
                            <button type="button" onclick="selectAllDays()" class="text-xs text-[#009cb6] hover:underline">Select All</button>
                            <button type="button" onclick="deselectAllDays()" class="text-xs text-gray-500 hover:underline">Deselect All</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded p-3 bg-gray-50">
                        ${availableDays.map(d => `
                            <label class="flex items-center gap-2 p-2 hover:bg-white rounded cursor-pointer transition-colors">
                                <input type="checkbox" value="${d}" class="copy-day-checkbox w-4 h-4 text-[#009cb6] border-gray-300 rounded">
                                <span class="text-sm font-medium">${d}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancel
                    </button>
                    <button onclick="applyCopyToSelectedDays('${location}', '${grupo}', ${sourceMonth}, ${sourceDay})" 
                            class="px-4 py-2 bg-[#009cb6] text-white rounded hover:bg-[#007a91] transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Copy to Selected
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        function toggleCopyMonthChip(chip) {
            if (chip.classList.contains('bg-[#009cb6]')) {
                chip.classList.remove('bg-[#009cb6]', 'text-white', 'border-[#009cb6]');
                chip.classList.add('border-gray-300');
            } else {
                chip.classList.add('bg-[#009cb6]', 'text-white', 'border-[#009cb6]');
                chip.classList.remove('border-gray-300');
            }
        }
        
        function toggleCopyDayChip(chip) {
            if (chip.classList.contains('bg-[#009cb6]')) {
                chip.classList.remove('bg-[#009cb6]', 'text-white', 'border-[#009cb6]');
                chip.classList.add('border-gray-300');
            } else {
                chip.classList.add('bg-[#009cb6]', 'text-white', 'border-[#009cb6]');
                chip.classList.remove('border-gray-300');
            }
        }
        
        function selectAllDays() {
            document.querySelectorAll('.copy-day-checkbox').forEach(cb => cb.checked = true);
        }
        
        function deselectAllDays() {
            document.querySelectorAll('.copy-day-checkbox').forEach(cb => cb.checked = false);
        }
        
        async function applyCopyToSelectedDays(location, grupo, sourceMonth, sourceDay) {
            try {
                // Get selected months
                const selectedMonths = [];
                document.querySelectorAll('.copy-month-chip.bg-\\[\\#009cb6\\]').forEach(chip => {
                    selectedMonths.push(parseInt(chip.dataset.month));
                });
                
                // Get selected days
                const selectedDays = [];
                document.querySelectorAll('.copy-day-checkbox:checked').forEach(cb => {
                    selectedDays.push(parseInt(cb.value));
                });
                
                if (selectedMonths.length === 0 || selectedDays.length === 0) {
                    alert('âš ï¸ Select at least one month and one day!');
                    return;
                }
                
                // Get source config
                const saved = localStorage.getItem('automatedPriceRules');
                const rules = saved ? JSON.parse(saved) : {};
                const sourceConfig = rules[location]?.[grupo]?.months?.[sourceMonth]?.days?.[sourceDay];
                
                if (!sourceConfig || !sourceConfig.strategies) {
                    alert('âš ï¸ No strategies to copy!');
                    return;
                }
            
                // Copy strategies
                let copiedCount = 0;
                selectedMonths.forEach(month => {
                    if (!rules[location]) rules[location] = {};
                    if (!rules[location][grupo]) rules[location][grupo] = { months: {} };
                    if (!rules[location][grupo].months[month]) rules[location][grupo].months[month] = { days: {} };
                    
                    selectedDays.forEach(day => {
                        if (month === sourceMonth && day === sourceDay) return;
                        
                        // Deep copy all strategies
                        rules[location][grupo].months[month].days[day] = JSON.parse(JSON.stringify(sourceConfig));
                        copiedCount++;
                    });
                });
                
                // Save
                localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
                console.log(`âœ… Copied to ${copiedCount} days`);
                
                // Save to database (async, don't wait)
                fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                }).catch(err => console.error('DB save error:', err));
                
                alert(`âœ… Copied to ${copiedCount} days!`);
                
            } catch (error) {
                console.error('âŒ Error during copy:', error);
                alert('âŒ Error copying: ' + error.message);
            } finally {
                // ALWAYS close modal
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) {
                    modal.remove();
                    console.log('ðŸšª Modal closed');
                } else {
                    console.log('âš ï¸ Modal not found');
                }
            }
        }
        
        // ===== MULTIPLE STRATEGIES MANAGEMENT =====
        
        let strategiesData = {}; // Store strategies per location/grupo/day
        
        function addStrategy(location, grupo) {
            const selectedMonth = getCurrentSelectedMonth(location, grupo);
            if (!selectedMonth) {
                alert('Please select a month first');
                return;
            }
            
            const currentDay = getCurrentSelectedDay(location, grupo);
            if (!currentDay) {
                alert('Please select a day first');
                return;
            }
            
            // Show strategy selection dialog
            showStrategySelectionDialog(location, grupo, selectedMonth.number, currentDay);
        }
        
        function showStrategySelectionDialog(location, grupo, month, day) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            
            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto';
            
            modal.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Select Pricing Strategy</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-3">
                    <button onclick="selectStrategy('${location}', '${grupo}', ${month}, ${day}, 'follow_lowest', 'Follow Lowest Price')" 
                            class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-[#009cb6] hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-[#009cb6] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Follow Lowest Price</h4>
                                <p class="text-sm text-gray-600">Follow the lowest price from all suppliers with a configurable difference (cents, euros, or percentage)</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="selectStrategy('${location}', '${grupo}', ${month}, ${day}, 'follow_suppliers', 'Follow Specific Suppliers')" 
                            class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-[#009cb6] hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-[#009cb6] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Follow Specific Suppliers</h4>
                                <p class="text-sm text-gray-600">Select specific suppliers to follow. Price will be the lowest among selected suppliers with configurable difference</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="selectStrategy('${location}', '${grupo}', ${month}, ${day}, 'follow_average', 'Follow Average Price')" 
                            class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-[#009cb6] hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-[#009cb6] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-[#009cb6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Follow Average Price</h4>
                                <p class="text-sm text-gray-600">Calculate the average (middle) price between selected suppliers with configurable difference</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="selectStrategy('${location}', '${grupo}', ${month}, ${day}, 'fixed_margin', 'Fixed Margin %')" 
                            class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-[#009cb6] hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-[#f4ad0f] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-[#f4ad0f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Fixed Margin %</h4>
                                <p class="text-sm text-gray-600">Apply a fixed percentage margin over the base price (e.g., 15% margin)</p>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="selectStrategy('${location}', '${grupo}', ${month}, ${day}, 'fixed_price', 'Fixed Price')" 
                            class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-[#009cb6] hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-[#f4ad0f] bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-[#f4ad0f]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-1">Fixed Price</h4>
                                <p class="text-sm text-gray-600">Set a fixed price in euros (e.g., 45.00â‚¬). Useful as a fallback strategy</p>
                            </div>
                        </div>
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        function selectStrategy(location, grupo, month, day, strategyType, strategyName) {
            const key = `${location}_${grupo}_${month}_${day}`;
            if (!strategiesData[key]) strategiesData[key] = [];
            
            const strategyId = Date.now();
            
            strategiesData[key].push({
                id: strategyId,
                type: strategyType,
                name: strategyName,
                config: {}
            });
            
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Render updated list
            renderStrategiesList(location, grupo, month, day);
            
            // Show success message
            showNotification(`âœ… ${strategyName} added as strategy #${strategiesData[key].length}`);
        }
        
        function renderStrategiesList(location, grupo, month, day) {
            const key = `${location}_${grupo}_${month}_${day}`;
            const container = document.getElementById(`strategiesList_${location}_${grupo}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const strategies = strategiesData[key] || [];
            
            if (strategies.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic">No strategies added yet. Click "+ Add Strategy" to start.</p>';
                return;
            }
            
            strategies.forEach((strategy, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-white border border-gray-300 rounded';
                
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-semibold text-[#f4ad0f]">#${index + 1}</span>
                        <span class="text-xs font-medium">${strategy.name}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="configureStrategy('${location}', '${grupo}', ${month}, ${day}, ${strategy.id})" class="px-2 py-1 text-xs bg-[#009cb6] text-white rounded hover:bg-[#f4ad0f]" title="Configure">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                        <button onclick="moveStrategyUp('${location}', '${grupo}', ${month}, ${day}, ${index})" class="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-100" title="Move up" ${index === 0 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                        </button>
                        <button onclick="moveStrategyDown('${location}', '${grupo}', ${month}, ${day}, ${index})" class="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-100" title="Move down" ${index === strategies.length - 1 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <button onclick="removeStrategy('${location}', '${grupo}', ${month}, ${day}, ${index})" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600" title="Remove">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }
        
        function configureStrategy(location, grupo, month, day, strategyId) {
            const key = `${location}_${grupo}_${month}_${day}`;
            const strategy = strategiesData[key]?.find(s => s.id === strategyId);
            
            if (!strategy) return;
            
            // Show strategy config section
            const configSection = document.getElementById(`strategyConfig_${location}_${grupo}`);
            const strategyName = document.getElementById(`currentStrategyName_${location}_${grupo}`);
            
            if (configSection && strategyName) {
                configSection.classList.remove('hidden');
                strategyName.textContent = strategy.name;
                
                // Show appropriate fields based on strategy type
                updateStrategyFields(location, grupo, strategy.type);
                
                // Load existing configuration
                loadStrategyConfiguration(location, grupo, strategy);
            }
        }
        
        function loadStrategyConfiguration(location, grupo, strategy) {
            // Load configuration into form fields
            // This will be implemented based on strategy type
        }
        
        function moveStrategyUp(location, grupo, month, day, index) {
            const key = `${location}_${grupo}_${month}_${day}`;
            if (index === 0) return;
            
            const temp = strategiesData[key][index];
            strategiesData[key][index] = strategiesData[key][index - 1];
            strategiesData[key][index - 1] = temp;
            
            renderStrategiesList(location, grupo, month, day);
        }
        
        function moveStrategyDown(location, grupo, month, day, index) {
            const key = `${location}_${grupo}_${month}_${day}`;
            if (index >= strategiesData[key].length - 1) return;
            
            const temp = strategiesData[key][index];
            strategiesData[key][index] = strategiesData[key][index + 1];
            strategiesData[key][index + 1] = temp;
            
            renderStrategiesList(location, grupo, month, day);
        }
        
        function removeStrategy(location, grupo, month, day, index) {
            if (!confirm('Remove this strategy?')) return;
            
            const key = `${location}_${grupo}_${month}_${day}`;
            strategiesData[key].splice(index, 1);
            
            renderStrategiesList(location, grupo, month, day);
        }
        
        function generateSuppliersCheckboxes(location, grupo) {
            const container = document.getElementById(`suppliersList_${location}_${grupo}`);
            if (!container) return;
            
            container.innerHTML = '';
            suppliers.forEach(supplier => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-1 hover:bg-gray-50 rounded';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `supplier_${location}_${grupo}_${supplier.replace(/\s+/g, '_')}`;
                checkbox.value = supplier;
                checkbox.className = 'w-4 h-4 text-[#009cb6] border-gray-300 rounded focus:ring-[#009cb6]';
                checkbox.dataset.location = location;
                checkbox.dataset.grupo = grupo;
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = supplier;
                label.className = 'text-xs text-gray-700 cursor-pointer flex-1';
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        function updateStrategyFields(location, grupo, strategyType = null) {
            const strategy = strategyType || document.getElementById(`strategy_${location}_${grupo}`)?.value;
            const followOptions = document.getElementById(`followOptions_${location}_${grupo}`);
            const suppliersOptions = document.getElementById(`suppliersOptions_${location}_${grupo}`);
            const marginOptions = document.getElementById(`marginOptions_${location}_${grupo}`);
            const fixedOptions = document.getElementById(`fixedOptions_${location}_${grupo}`);
            
            if (!followOptions) return; // Elements not yet created
            
            followOptions.classList.add('hidden');
            suppliersOptions.classList.add('hidden');
            marginOptions.classList.add('hidden');
            fixedOptions.classList.add('hidden');
            
            if (strategy === 'follow_lowest') {
                followOptions.classList.remove('hidden');
            } else if (strategy === 'follow_suppliers') {
                suppliersOptions.classList.remove('hidden');
            } else if (strategy === 'follow_average') {
                // Follow average usa os mesmos campos que follow_suppliers
                suppliersOptions.classList.remove('hidden');
            } else if (strategy === 'fixed_margin') {
                marginOptions.classList.remove('hidden');
            } else if (strategy === 'fixed_price') {
                fixedOptions.classList.remove('hidden');
            }
        }
        
        // Save configuration for the CURRENTLY SELECTED day
        async function saveCurrentDayConfiguration(location, grupo) {
            const currentMonth = getCurrentSelectedMonth(location, grupo);
            const currentDay = getCurrentSelectedDay(location, grupo);
            
            if (!currentMonth || !currentDay) {
                alert('âš ï¸ Please select a month and day first!');
                return;
            }
            
            console.log(`ðŸ’¾ðŸ’¾ðŸ’¾ USER CLICKED SAVE for ${location}/${grupo}/${currentMonth.number}/${currentDay}`);
            await saveConfigForGroup(location, grupo, currentMonth.number, currentDay);
        }
        
        // Save configuration for a SPECIFIC group/month/day
        async function saveConfigForGroup(location, grupo, month, day) {
            // Load existing rules
            const saved = localStorage.getItem('automatedPriceRules');
            let rules = saved ? JSON.parse(saved) : {};
            
            // Initialize structure if not exists
            if (!rules[location]) rules[location] = {};
            if (!rules[location][grupo]) rules[location][grupo] = { months: {} };
            if (!rules[location][grupo].months[month]) rules[location][grupo].months[month] = { days: {} };
            
            // Get current field values
            const strategy = document.getElementById(`strategy_${location}_${grupo}`)?.value;
            
            if (!strategy) {
                console.log(`âš ï¸ No strategy selected for ${location}/${grupo}/${month}/${day}`);
                return;
            }
            
            // Get selected suppliers
            const selectedSuppliers = [];
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-location="${location}"][data-grupo="${grupo}"]:checked`);
            checkboxes.forEach(cb => selectedSuppliers.push(cb.value));
            
            // Get operation (+/-)
            const diffOperationRadio = document.querySelector(`input[name="diffOperation_${location}_${grupo}"]:checked`);
            const diffOperation = diffOperationRadio ? diffOperationRadio.value : 'subtract';  // Default: subtract
            
            const supplierDiffOperationRadio = document.querySelector(`input[name="supplierDiffOperation_${location}_${grupo}"]:checked`);
            const supplierDiffOperation = supplierDiffOperationRadio ? supplierDiffOperationRadio.value : 'subtract';  // Default: subtract
            
            const marginOperationRadio = document.querySelector(`input[name="marginOperation_${location}_${grupo}"]:checked`);
            const marginOperation = marginOperationRadio ? marginOperationRadio.value : 'subtract';  // Default: subtract
            
            // Save configuration for THIS SPECIFIC month and day ONLY
            rules[location][grupo].months[month].days[day] = {
                strategy: strategy,
                diffType: document.getElementById(`diffType_${location}_${grupo}`)?.value,
                diffValue: parseFloat(document.getElementById(`diffValue_${location}_${grupo}`)?.value) || 0,
                diffOperation: diffOperation,  // 'add' or 'subtract'
                selectedSuppliers: selectedSuppliers,
                supplierDiffType: document.getElementById(`supplierDiffType_${location}_${grupo}`)?.value,
                supplierDiffValue: parseFloat(document.getElementById(`supplierDiffValue_${location}_${grupo}`)?.value) || 0,
                supplierDiffOperation: supplierDiffOperation,  // 'add' or 'subtract'
                margin: parseFloat(document.getElementById(`margin_${location}_${grupo}`)?.value) || 0,
                marginOperation: marginOperation,  // 'add' or 'subtract'
                fixedPrice: parseFloat(document.getElementById(`fixedPrice_${location}_${grupo}`)?.value) || 0,
                minPriceDay: parseFloat(document.getElementById(`minPriceDay_${location}_${grupo}`)?.value) || null,
                minPriceMonth: parseFloat(document.getElementById(`minPriceMonth_${location}_${grupo}`)?.value) || null
            };
            
            console.log(`ðŸ’¾ Saving config for ${location}/${grupo}/${month}/${day}:`, rules[location][grupo].months[month].days[day]);
            
            try {
                // Save to database via API
                const response = await fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    // Also save to localStorage as backup
                    localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
                    console.log(`âœ… Config saved for ${location}/${grupo}/${month}/${day}`);
                    showNotification('âœ… Configuration saved!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (err) {
                console.error('Error saving config:', err);
                // Fallback to localStorage only
                localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
                console.log('âš ï¸ Config saved to localStorage only (fallback)');
            }
        }
        
        // OLD function kept for compatibility with global save
        async function saveAutomatedRules() {
            // This function is now only called from the main "Save Settings" button
            // It does NOT save automated rules anymore - those are saved per group
            console.log('â„¹ï¸ Automated rules are saved automatically when you change fields');
            return {};
        }
        
        async function saveStrategies() {
            try {
                // Save strategies to database via API
                const response = await fetch('/api/price-automation/strategies/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(strategiesData)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    console.log('âœ… Strategies saved to database');
                } else {
                    throw new Error(result.error || 'Failed to save strategies');
                }
            } catch (err) {
                console.error('Error saving strategies to database:', err);
            }
        }
        
        async function loadStrategies() {
            try {
                // Load strategies from database
                const response = await fetch('/api/price-automation/strategies/load');
                const result = await response.json();
                
                if (result.ok && result.strategies) {
                    strategiesData = result.strategies;
                    console.log('âœ… Strategies loaded from database');
                    
                    // Render strategies for all groups
                    const locations = ['Albufeira', 'Aeroporto de Faro'];
                    locations.forEach(location => {
                        grupos.forEach(grupo => {
                            const currentDay = getCurrentSelectedDay(location, grupo);
                            const currentMonth = getCurrentSelectedMonth(location, grupo);
                            if (currentDay && currentMonth) {
                                renderStrategiesList(location, grupo, currentMonth.number, currentDay);
                            }
                        });
                    });
                }
            } catch (err) {
                console.error('Error loading strategies from database:', err);
            }
        }
        
        // ===== EXPORT / IMPORT SETTINGS =====
        
        function exportSettings() {
            // Collect all settings
            const allSettings = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                globalSettings: {
                    comissaoBroker: parseFloat(document.getElementById('comissaoBroker')?.value) || 0,
                    defaultMargin: parseFloat(document.getElementById('defaultMargin')?.value) || 0,
                    rounding: document.getElementById('rounding')?.value || '0.01',
                    maxAlternativeDays: parseInt(document.getElementById('maxAlternativeDays')?.value) || 3,
                    defaultLocation: document.getElementById('defaultLocation')?.value || 'Albufeira',
                    autoSaveHistory: document.getElementById('autoSaveHistory')?.value === 'true'
                },
                automatedPriceRules: JSON.parse(localStorage.getItem('automatedPriceRules') || '{}'),
                strategiesData: strategiesData || {}
            };
            
            // Create JSON file
            const dataStr = JSON.stringify(allSettings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `price_automation_settings_${new Date().toISOString().split('T')[0]}.json`;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('âœ… Settings exported successfully!');
        }
        
        function importSettings() {
            // Trigger file input
            document.getElementById('importFileInput').click();
        }
        
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedSettings = JSON.parse(e.target.result);
                    
                    // Validate format
                    if (!importedSettings.version || !importedSettings.globalSettings) {
                        alert('âŒ Invalid settings file format');
                        return;
                    }
                    
                    // Confirm import
                    if (!confirm('âš ï¸ This will overwrite all current settings. Continue?')) {
                        return;
                    }
                    
                    // Apply global settings
                    const gs = importedSettings.globalSettings;
                    if (gs.comissaoBroker !== undefined) document.getElementById('comissaoBroker').value = gs.comissaoBroker;
                    if (gs.defaultMargin !== undefined) document.getElementById('defaultMargin').value = gs.defaultMargin;
                    if (gs.rounding) document.getElementById('rounding').value = gs.rounding;
                    if (gs.maxAlternativeDays !== undefined) document.getElementById('maxAlternativeDays').value = gs.maxAlternativeDays;
                    if (gs.defaultLocation) document.getElementById('defaultLocation').value = gs.defaultLocation;
                    if (gs.autoSaveHistory !== undefined) document.getElementById('autoSaveHistory').value = gs.autoSaveHistory ? 'true' : 'false';
                    
                    // Save global settings
                    saveSettings();
                    
                    // Apply automated price rules
                    if (importedSettings.automatedPriceRules) {
                        localStorage.setItem('automatedPriceRules', JSON.stringify(importedSettings.automatedPriceRules));
                    }
                    
                    // Apply strategies data
                    if (importedSettings.strategiesData) {
                        strategiesData = importedSettings.strategiesData;
                    }
                    
                    showNotification('âœ… Settings imported successfully! Reloading page...');
                    
                    // Reload page to apply all changes
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('âŒ Error importing settings: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // ===== DEBUG & TROUBLESHOOTING =====
        
        function debugShowData() {
            const saved = localStorage.getItem('automatedPriceRules');
            
            console.log('='.repeat(60));
            console.log('ðŸ“Š DEBUG: Automated Price Rules Data');
            console.log('='.repeat(60));
            
            if (!saved) {
                console.log('âŒ No data found in localStorage');
                alert('âŒ No data found in localStorage.\n\nCheck console (F12) for details.');
                return;
            }
            
            try {
                const rules = JSON.parse(saved);
                console.log('ðŸ“ Raw Data:', JSON.stringify(rules, null, 2));
                console.log('\nðŸ“‹ Structure Analysis:');
                
                let totalConfigs = 0;
                for (const location in rules) {
                    console.log(`\nðŸŒ Location: ${location}`);
                    for (const grupo in rules[location]) {
                        const grupoData = rules[location][grupo];
                        
                        if (grupoData.months) {
                            // New format
                            const monthCount = Object.keys(grupoData.months).length;
                            let dayCount = 0;
                            for (const month in grupoData.months) {
                                const days = Object.keys(grupoData.months[month].days || {});
                                dayCount += days.length;
                                if (days.length > 0) {
                                    console.log(`  ðŸ“… ${grupo} - Month ${month}: ${days.join(', ')} days configured`);
                                }
                            }
                            totalConfigs += dayCount;
                        } else {
                            // Old format (ERROR!)
                            console.warn(`  âš ï¸ ${grupo}: OLD FORMAT DETECTED! This should not happen.`);
                            console.log(`     Data:`, grupoData);
                        }
                    }
                }
                
                console.log(`\nâœ… Total configurations: ${totalConfigs}`);
                console.log('='.repeat(60));
                
                // Show summary alert
                alert(`ðŸ“Š Debug Data Summary:\n\n` +
                      `Total Configurations: ${totalConfigs}\n\n` +
                      `Check console (F12) for detailed breakdown.`);
                
            } catch (e) {
                console.error('âŒ Error parsing data:', e);
                alert('âŒ Error parsing data.\n\nCheck console (F12) for details.');
            }
        }
        
        function showCopyStrategiesToDaysModal(location, grupo) {
            // Get selected month and day
            const monthChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-month][data-selected="true"]`);
            const dayChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-day][data-selected="true"]`);
            
            if (!monthChip || !dayChip) {
                alert('âš ï¸ Please select a month and day first!');
                return;
            }
            
            const currentMonth = parseInt(monthChip.dataset.month);
            const monthName = monthChip.textContent.trim();
            const currentDay = parseInt(dayChip.dataset.day);
            
            // Get current strategies
            const rules = JSON.parse(localStorage.getItem('automatedPriceRules') || '{}');
            
            const dayConfig = rules[location]?.[grupo]?.months?.[currentMonth]?.days?.[currentDay];
            console.log(`ðŸ“‹ Copy from: ${location}/${grupo}/${monthName}/${currentDay}d`, dayConfig);
            
            // Get strategies - support both new and old format
            let strategies = [];
            
            if (dayConfig?.strategies && dayConfig.strategies.length > 0) {
                // New format with strategies array
                strategies = dayConfig.strategies;
            } else if (dayConfig) {
                // Old format - convert entire dayConfig to strategy
                strategies = [{
                    type: dayConfig.strategy || 'follow_lowest',
                    diffType: dayConfig.diffType || 'percentage',
                    diffValue: dayConfig.diffValue || 0,
                    diffOperation: dayConfig.diffOperation || 'subtract',
                    selectedSuppliers: dayConfig.selectedSuppliers || [],
                    supplierDiffType: dayConfig.supplierDiffType,
                    supplierDiffValue: dayConfig.supplierDiffValue,
                    supplierDiffOperation: dayConfig.supplierDiffOperation,
                    margin: dayConfig.margin,
                    marginOperation: dayConfig.marginOperation,
                    fixedPrice: dayConfig.fixedPrice
                }];
            }
            
            if (strategies.length === 0) {
                alert('âš ï¸ No configuration found for this day!\n\nPlease configure at least one strategy first.');
                return;
            }
            
            console.log(`âœ… Found ${strategies.length} strategy(s):`, strategies);
            
            // Create modal
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto';
            
            modal.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Copy Strategies to Other Days</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm">
                        <strong>Source:</strong> ${location} â†’ ${grupo} â†’ ${monthName} â†’ ${currentDay}d
                    </div>
                    
                    <!-- Select Strategies -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Strategies to Copy:</label>
                        <div class="space-y-2 border border-gray-300 rounded p-3 bg-gray-50">
                            ${strategies.map((strat, idx) => `
                                <label class="flex items-start cursor-pointer hover:bg-white p-2 rounded">
                                    <input type="checkbox" value="${idx}" checked class="mr-2 mt-1 copy-strategy-checkbox">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">#${idx + 1} - ${getStrategyTypeName(strat.type)}</div>
                                        <div class="text-xs text-gray-600">${getStrategyDescription(strat)}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Select Target Months -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select month:</label>
                        <div class="flex flex-wrap gap-2">
                            ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].map((monthName, idx) => {
                                const monthNum = idx + 1;
                                const isSelected = monthNum === currentMonth;
                                const bgColor = isSelected ? 'bg-[#009cb6] text-white border-[#009cb6]' : 'bg-white text-gray-700 border-gray-300';
                                return `
                                    <button type="button" 
                                            data-month="${monthNum}"
                                            onclick="this.classList.toggle('bg-[#009cb6]'); this.classList.toggle('text-white'); this.classList.toggle('border-[#009cb6]'); this.classList.toggle('bg-white'); this.classList.toggle('text-gray-700'); this.classList.toggle('border-gray-300')"
                                            class="copy-month-chip px-3 py-2 border ${bgColor} hover:border-[#009cb6] transition-colors text-sm font-medium">
                                        ${monthName}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Select Target Groups -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select vehicle groups:</label>
                        <div class="flex flex-wrap gap-2">
                            ${['B1','B2','D','E1','E2','F','G','J1','J2','L1','L2','M1','M2','N'].map(g => {
                                const isSelected = g === grupo;
                                const bgColor = isSelected ? 'bg-[#f4ad0f] text-white border-[#f4ad0f]' : 'bg-white text-gray-700 border-gray-300';
                                return `
                                    <button type="button" 
                                            data-grupo="${g}"
                                            onclick="this.classList.toggle('bg-[#f4ad0f]'); this.classList.toggle('text-white'); this.classList.toggle('border-[#f4ad0f]'); this.classList.toggle('bg-white'); this.classList.toggle('text-gray-700'); this.classList.toggle('border-gray-300')"
                                            class="copy-grupo-chip px-3 py-2 border ${bgColor} hover:border-[#f4ad0f] transition-colors text-sm font-medium">
                                        ${g}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Select Target Days -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select day to configure:</label>
                        <div class="flex flex-wrap gap-2">
                            ${[1,2,3,4,5,6,7,8,9,14,21,22,28,30,31,60].map(day => {
                                const isSource = day === currentDay;
                                const bgColor = 'bg-white text-gray-700 border-gray-300';
                                const cursor = isSource ? 'cursor-not-allowed opacity-40' : '';
                                return `
                                    <button type="button" 
                                            data-day="${day}"
                                            ${isSource ? 'disabled' : ''}
                                            onclick="if(!this.disabled) { this.classList.toggle('bg-[#f4ad0f]'); this.classList.toggle('text-white'); this.classList.toggle('border-[#f4ad0f]'); this.classList.toggle('bg-white'); this.classList.toggle('text-gray-700'); this.classList.toggle('border-gray-300'); }"
                                            class="copy-day-chip px-3 py-2 border ${bgColor} hover:border-[#f4ad0f] transition-colors text-sm font-medium ${cursor}">
                                        ${day}d
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-2 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="executeCopyStrategiesToDays('${location}', '${grupo}', ${currentMonth}, ${currentDay})" class="px-4 py-2 bg-[#009cb6] text-white rounded hover:bg-[#007a91]">
                            Copy Selected Strategies
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        function getStrategyTypeName(type) {
            const names = {
                'follow_lowest': 'Follow Lowest Price',
                'follow_suppliers': 'Follow Specific Suppliers',
                'follow_average': 'Follow Average Price',
                'fixed_margin': 'Fixed Margin %',
                'fixed_price': 'Fixed Price'
            };
            return names[type] || type;
        }
        
        function getStrategyDescription(strat) {
            if (strat.type === 'follow_lowest') {
                const op = strat.diffOperation === 'subtract' ? '-' : '+';
                return `${op}${strat.diffValue} ${strat.diffType}`;
            } else if (strat.type === 'follow_suppliers') {
                return `Suppliers: ${strat.suppliers?.join(', ') || 'None'}`;
            } else if (strat.type === 'fixed_margin') {
                return `Margin: ${strat.margin}%`;
            } else if (strat.type === 'fixed_price') {
                return `Price: ${strat.fixedPrice}â‚¬`;
            }
            return '';
        }
        
        async function executeCopyStrategiesToDays(location, grupo, sourceMonth, sourceDay) {
            // Get selected strategies
            const selectedStrategyIndexes = [];
            document.querySelectorAll('.copy-strategy-checkbox:checked').forEach(cb => {
                selectedStrategyIndexes.push(parseInt(cb.value));
            });
            
            // Get selected months (turquesa chips)
            const selectedMonths = [];
            document.querySelectorAll('.copy-month-chip.bg-\\[\\#009cb6\\]').forEach(btn => {
                selectedMonths.push(parseInt(btn.dataset.month));
            });
            
            // Get selected groups (amarelo chips)
            const selectedGrupos = [];
            document.querySelectorAll('.copy-grupo-chip.bg-\\[\\#f4ad0f\\]').forEach(btn => {
                selectedGrupos.push(btn.dataset.grupo);
            });
            
            // Get selected days (amarelo chips)
            const selectedDays = [];
            document.querySelectorAll('.copy-day-chip.bg-\\[\\#f4ad0f\\]').forEach(btn => {
                selectedDays.push(parseInt(btn.dataset.day));
            });
            
            if (selectedStrategyIndexes.length === 0) {
                alert('âš ï¸ Please select at least one strategy to copy!');
                return;
            }
            
            if (selectedGrupos.length === 0) {
                alert('âš ï¸ Please select at least one vehicle group!');
                return;
            }
            
            if (selectedMonths.length === 0) {
                alert('âš ï¸ Please select at least one target month!');
                return;
            }
            
            if (selectedDays.length === 0) {
                alert('âš ï¸ Please select at least one target day!');
                return;
            }
            
            // Load rules
            const rules = JSON.parse(localStorage.getItem('automatedPriceRules') || '{}');
            const sourceStrategies = rules[location]?.[grupo]?.months?.[sourceMonth]?.days?.[sourceDay]?.strategies || [];
            
            console.log(`ðŸ“¦ SOURCE: ${location}/${grupo}/${sourceMonth}/${sourceDay}`);
            console.log(`ðŸ“‹ sourceStrategies:`, sourceStrategies);
            console.log(`ðŸŽ¯ selectedStrategyIndexes:`, selectedStrategyIndexes);
            
            // Get selected strategies to copy
            const strategiesToCopy = selectedStrategyIndexes.map(idx => sourceStrategies[idx]).filter(s => s);
            
            console.log(`âœ‚ï¸ strategiesToCopy:`, strategiesToCopy);
            
            if (strategiesToCopy.length === 0) {
                alert('âŒ ERROR: No strategies to copy!\n\nCheck console for details.');
                return;
            }
            
            // Copy to each selected group, month and day combination
            let copiedCount = 0;
            for (const targetGrupo of selectedGrupos) {
                for (const targetMonth of selectedMonths) {
                    for (const targetDay of selectedDays) {
                        // Skip if same as source
                        if (targetGrupo === grupo && targetMonth === sourceMonth && targetDay === sourceDay) continue;
                        
                        if (!rules[location]) rules[location] = {};
                        if (!rules[location][targetGrupo]) rules[location][targetGrupo] = { months: {} };
                        if (!rules[location][targetGrupo].months[targetMonth]) rules[location][targetGrupo].months[targetMonth] = { days: {} };
                        if (!rules[location][targetGrupo].months[targetMonth].days[targetDay]) {
                            rules[location][targetGrupo].months[targetMonth].days[targetDay] = { strategies: [] };
                        }
                        
                        // Append strategies (don't replace existing, append)
                        rules[location][targetGrupo].months[targetMonth].days[targetDay].strategies.push(...strategiesToCopy);
                        copiedCount++;
                    }
                }
            }
            
            // Save
            localStorage.setItem('automatedPriceRules', JSON.stringify(rules));
            
            try {
                await fetch('/api/price-automation/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
            } catch (e) {
                console.error('Error saving:', e);
            }
            
            // Close modal
            document.querySelector('.fixed.inset-0').remove();
            
            // Show success and reload current view if needed
            alert(`âœ… Copied ${selectedStrategyIndexes.length} strategy(s) to ${copiedCount} location(s)\n(${selectedGrupos.length} group(s) Ã— ${selectedMonths.length} month(s) Ã— ${selectedDays.length} day(s))!`);
            
            // If current day is one of the target days, rebuild to show new strategies
            const currentDayChip = document.querySelector(`button[data-location="${location}"][data-grupo="${grupo}"][data-day][data-selected="true"]`);
            if (currentDayChip) {
                const currentDay = parseInt(currentDayChip.dataset.day);
                if (selectedDays.includes(currentDay)) {
                    console.log('ðŸ”„ Reloading current day to show copied strategies...');
                    rebuildFieldsForDay(location, grupo, sourceMonth, currentDay);
                }
            }
        }
        
        function clearAllRules() {
            if (!confirm('ðŸ—‘ï¸ Clear ALL automated price rules?\n\n' +
                        'This will DELETE all configurations for all locations, groups, months and days.\n\n' +
                        'âš ï¸ This action cannot be undone!\n\n' +
                        'Click OK to proceed or Cancel to abort.')) {
                return;
            }
            
            // Second confirmation
            if (!confirm('âš ï¸ FINAL WARNING!\n\n' +
                        'Are you absolutely sure?\n\n' +
                        'All your automated price rules will be permanently deleted.')) {
                return;
            }
            
            console.log('ðŸ—‘ï¸ Clearing all automated price rules...');
            
            // Clear localStorage
            localStorage.removeItem('automatedPriceRules');
            console.log('âœ… localStorage cleared');
            
            // Clear from database
            const emptyRules = {
                "Albufeira": {},
                "Aeroporto de Faro": {}
            };
            
            fetch('/api/price-automation/rules/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(emptyRules)
            })
            .then(r => r.json())
            .then(result => {
                console.log('âœ… Database cleared');
                alert('âœ… All rules cleared! Reloading page...');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('âŒ Error:', error);
                alert('âœ… Rules cleared from localStorage! Page will reload...');
                setTimeout(() => location.reload(), 1000);
            });
        }
    </script>
</body>
</html>
